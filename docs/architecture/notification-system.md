# ä¼ä¸šçº§æ¶ˆæ¯é€šçŸ¥ç³»ç»Ÿæ¶æ„æŠ¥å‘Š

> åŸºäº Kafka + WebSocket + Redis çš„ç»Ÿä¸€æ¶ˆæ¯é€šçŸ¥ç³»ç»Ÿ
>
> **ç‰ˆæœ¬**: v2.0
> **æ—¥æœŸ**: 2025-12-09
> **ä½œè€…**: CMSWE å¼€å‘å›¢é˜Ÿ

---

## ğŸ“– ç›®å½•

- [é¡¹ç›®èƒŒæ™¯](#é¡¹ç›®èƒŒæ™¯)
- [è®¾è®¡ç›®æ ‡](#è®¾è®¡ç›®æ ‡)
- [æ ¸å¿ƒæ¶æ„](#æ ¸å¿ƒæ¶æ„)
- [æŠ€æœ¯é€‰å‹](#æŠ€æœ¯é€‰å‹)
- [è®¾è®¡æ¨¡å¼](#è®¾è®¡æ¨¡å¼)
- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
- [ä»£ç ç»“æ„](#ä»£ç ç»“æ„)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
- [ç›‘æ§å’Œè¿ç»´](#ç›‘æ§å’Œè¿ç»´)
- [æœªæ¥è§„åˆ’](#æœªæ¥è§„åˆ’)

---

## é¡¹ç›®èƒŒæ™¯

### ä¼˜åŒ–å‰çš„é—®é¢˜

âŒ **ç¼ºä¹ç»Ÿä¸€è®¾è®¡** - P2Pæ¶ˆæ¯ã€ç¾¤èŠã€ç³»ç»Ÿé€šçŸ¥ç­‰æ··åœ¨ä¸€èµ·
âŒ **åŠŸèƒ½å•ä¸€** - ç”Ÿäº§è€…åªæ”¯æŒåŸºæœ¬å‘é€ï¼Œç¼ºå°‘ä¸šåŠ¡å°è£…
âŒ **æ¶ˆè´¹é€»è¾‘ç®€å•** - WebSocketæ¨é€åŠŸèƒ½æœªå®Œæˆ
âŒ **å¯é æ€§ä¸è¶³** - ç¼ºå°‘é‡è¯•ã€æ­»ä¿¡é˜Ÿåˆ—ã€å¹‚ç­‰æ€§ä¿è¯
âŒ **éš¾ä»¥æ‰©å±•** - æ–°å¢æ¶ˆæ¯ç±»å‹éœ€è¦å¤§é‡ä¿®æ”¹

### ä¼˜åŒ–ç›®æ ‡

âœ… **ç»Ÿä¸€æ¶ˆæ¯æ¨¡å‹** - æ‰€æœ‰æ¶ˆæ¯ç±»å‹ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®æ¨¡å‹
âœ… **ä¼ä¸šçº§æ ‡å‡†** - åº”ç”¨è®¾è®¡æ¨¡å¼ï¼Œæå‡ä»£ç è´¨é‡
âœ… **é«˜å¯ç”¨æ€§** - æ¶ˆæ¯å¹‚ç­‰ã€é‡è¯•æœºåˆ¶ã€æ­»ä¿¡é˜Ÿåˆ—
âœ… **é«˜æ€§èƒ½** - å¼‚æ­¥å¤„ç†ã€æ‰¹é‡æ“ä½œã€ç¼“å­˜ä¼˜åŒ–
âœ… **æ˜“æ‰©å±•** - æ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼Œä¾¿äºæ–°å¢åŠŸèƒ½

---

## è®¾è®¡ç›®æ ‡

### åŠŸèƒ½æ€§ç›®æ ‡

1. **æ”¯æŒå¤šç§æ¶ˆæ¯ç±»å‹**
   - P2Pæ¶ˆæ¯ï¼ˆç‚¹å¯¹ç‚¹èŠå¤©ï¼‰
   - ç¾¤èŠæ¶ˆæ¯
   - ç³»ç»Ÿé€šçŸ¥ï¼ˆå…¬å‘Šã€ä¼šå‘˜æé†’ã€ä¼˜æƒ åˆ¸ç­‰ï¼‰
   - ç»„ç»‡é€šçŸ¥ï¼ˆæ´»åŠ¨ã€å…¬å‘Šï¼‰
   - ä¸šåŠ¡é€šçŸ¥ï¼ˆå…³æ³¨ã€ç‚¹èµã€è¯„è®ºç­‰ï¼‰

2. **æ¶ˆæ¯å¯é æ€§ä¿éšœ**
   - æ¶ˆæ¯å¹‚ç­‰æ€§ï¼ˆé˜²æ­¢é‡å¤æ¶ˆè´¹ï¼‰
   - æ¶ˆæ¯é‡è¯•æœºåˆ¶
   - æ­»ä¿¡é˜Ÿåˆ—å¤„ç†
   - æ¶ˆæ¯æŒä¹…åŒ–

3. **å®æ—¶æ¨é€**
   - WebSocketå®æ—¶æ¨é€
   - åœ¨çº¿çŠ¶æ€æ£€æµ‹
   - ç¦»çº¿æ¶ˆæ¯å­˜å‚¨

### éåŠŸèƒ½æ€§ç›®æ ‡

| æŒ‡æ ‡       | ç›®æ ‡å€¼               |
| ---------- | -------------------- |
| å¯ç”¨æ€§     | 99.9%                |
| æ¶ˆæ¯å»¶è¿Ÿ   | < 100ms (P95)        |
| ååé‡     | > 10000 msg/s        |
| æ¶ˆæ¯å¯é æ€§ | 99.99%               |
| æ‰©å±•æ€§     | æ”¯æŒæ°´å¹³æ‰©å±•         |

---

## æ ¸å¿ƒæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ä¸šåŠ¡åº”ç”¨å±‚                                     â”‚
â”‚  (Controller, Service)                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ è°ƒç”¨
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ¶ˆæ¯ç”Ÿäº§è€…å±‚ï¼ˆç­–ç•¥æ¨¡å¼ï¼‰                             â”‚
â”‚                                                                          â”‚
â”‚                      UnifiedMessageService                               â”‚
â”‚                         (é—¨é¢æ¨¡å¼)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ P2P       â”‚ Group     â”‚ System    â”‚ Org       â”‚ Business  â”‚         â”‚
â”‚  â”‚ Producer  â”‚ Producer  â”‚ Producer  â”‚ Producer  â”‚ Producer  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚       â”‚            â”‚            â”‚           â”‚           â”‚               â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                â”‚                                         â”‚
â”‚                           KafkaUtils                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ Kafkaæ¶ˆæ¯
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Kafkaé›†ç¾¤                                       â”‚
â”‚                                                                          â”‚
â”‚  Topics:                                                                 â”‚
â”‚  â€¢ user.message.p2p              (P2Pæ¶ˆæ¯)                              â”‚
â”‚  â€¢ group.message.chat            (ç¾¤èŠæ¶ˆæ¯)                             â”‚
â”‚  â€¢ system.notification           (ç³»ç»Ÿé€šçŸ¥)                             â”‚
â”‚  â€¢ organization.notification     (ç»„ç»‡é€šçŸ¥)                             â”‚
â”‚  â€¢ business.notification         (ä¸šåŠ¡é€šçŸ¥)                             â”‚
â”‚  â€¢ message.dlq / notification.dlq (æ­»ä¿¡é˜Ÿåˆ—)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ æ¶ˆè´¹
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¶ˆæ¯æ¶ˆè´¹è€…å±‚ï¼ˆè´£ä»»é“¾æ¨¡å¼ï¼‰                             â”‚
â”‚                                                                          â”‚
â”‚                    UnifiedMessageConsumer                                â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                 â”‚  æ¶ˆæ¯å¹‚ç­‰æ€§æ£€æŸ¥        â”‚                                â”‚
â”‚                 â”‚ (MessageIdempotent)   â”‚                                â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                            â”‚                                             â”‚
â”‚                            â–¼                                             â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                 â”‚  è´£ä»»é“¾å¤„ç†å™¨         â”‚                                â”‚
â”‚                 â”‚                       â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                                â”‚
â”‚  â”‚ 1. WebSocketPushHandler          â”‚â”‚                                â”‚
â”‚  â”‚    â€¢ åœ¨çº¿ç”¨æˆ·å®æ—¶æ¨é€              â”‚â”‚                                â”‚
â”‚  â”‚    â€¢ æ”¯æŒP2Pã€ç¾¤èŠã€é€šçŸ¥          â”‚â”‚                                â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚                                â”‚
â”‚  â”‚ 2. DatabasePersistHandler        â”‚â”‚                                â”‚
â”‚  â”‚    â€¢ æ¶ˆæ¯æŒä¹…åŒ–åˆ°æ•°æ®åº“            â”‚â”‚                                â”‚
â”‚  â”‚    â€¢ æ”¯æŒæ‰¹é‡ä¿å­˜                  â”‚â”‚                                â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚                                â”‚
â”‚  â”‚ 3. RedisCacheHandler             â”‚â”‚                                â”‚
â”‚  â”‚    â€¢ æœªè¯»æ¶ˆæ¯è®¡æ•°æ›´æ–°              â”‚â”‚                                â”‚
â”‚  â”‚    â€¢ æœ€è¿‘æ¶ˆæ¯ç¼“å­˜                  â”‚â”‚                                â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚                                â”‚
â”‚  â”‚ 4. OfflineMessageHandler         â”‚â”‚                                â”‚
â”‚  â”‚    â€¢ ç¦»çº¿ç”¨æˆ·æ¶ˆæ¯å­˜å‚¨              â”‚â”‚                                â”‚
â”‚  â”‚    â€¢ ä¸Šçº¿æ—¶è‡ªåŠ¨æ¨é€                â”‚â”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                                â”‚
â”‚                 â”‚                       â”‚                                â”‚
â”‚                 â–¼                       â”‚                                â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚                                â”‚
â”‚        â”‚  å¤±è´¥å¤„ç†      â”‚               â”‚                                â”‚
â”‚        â”‚ (DeadLetterQueue)â”‚             â”‚                                â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                      â”‚
                    â–¼                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   WebSocketå±‚      â”‚  â”‚   å­˜å‚¨å±‚           â”‚
        â”‚  â€¢ Netty Server    â”‚  â”‚  â€¢ MySQL           â”‚
        â”‚  â€¢ åœ¨çº¿ç”¨æˆ·ç®¡ç†     â”‚  â”‚  â€¢ Redis           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµå›¾

```
å‘é€æ¶ˆæ¯æµç¨‹:
ä¸šåŠ¡ä»£ç  â†’ UnifiedMessageService â†’ MessageProducer â†’ Kafka Topic

æ¶ˆè´¹æ¶ˆæ¯æµç¨‹:
Kafka Topic â†’ UnifiedMessageConsumer â†’ å¹‚ç­‰æ€§æ£€æŸ¥ â†’ è´£ä»»é“¾å¤„ç†å™¨
  â†’ [WebSocketæ¨é€ â†’ æ•°æ®åº“ä¿å­˜ â†’ Redisç¼“å­˜ â†’ ç¦»çº¿æ¶ˆæ¯å¤„ç†]
```

---

## æŠ€æœ¯é€‰å‹

### æ ¸å¿ƒæŠ€æœ¯æ ˆ

| æŠ€æœ¯            | ç‰ˆæœ¬    | ç”¨é€”                          |
| --------------- | ------- | ----------------------------- |
| Spring Boot     | 3.x     | åº”ç”¨æ¡†æ¶                      |
| Apache Kafka    | 3.x     | æ¶ˆæ¯é˜Ÿåˆ—                      |
| Netty           | 4.x     | WebSocketæœåŠ¡å™¨               |
| Redis           | 7.x     | ç¼“å­˜ã€ç¦»çº¿æ¶ˆæ¯å­˜å‚¨            |
| MySQL           | 8.x     | æ¶ˆæ¯æŒä¹…åŒ–                    |
| Jackson         | 2.x     | JSONåºåˆ—åŒ–                    |

### ä¸ºä»€ä¹ˆé€‰æ‹© Kafkaï¼Ÿ

âœ… **é«˜ååé‡** - æ”¯æŒç™¾ä¸‡çº§æ¶ˆæ¯/ç§’
âœ… **æŒä¹…åŒ–** - æ¶ˆæ¯å¯é å­˜å‚¨
âœ… **æ°´å¹³æ‰©å±•** - æ”¯æŒåˆ†åŒºå’Œé›†ç¾¤
âœ… **æ¶ˆæ¯å›æº¯** - æ”¯æŒé‡æ–°æ¶ˆè´¹å†å²æ¶ˆæ¯
âœ… **æˆç†Ÿç¨³å®š** - å¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒéªŒè¯

---

## è®¾è®¡æ¨¡å¼

### 1. ç­–ç•¥æ¨¡å¼ï¼ˆMessageProducerï¼‰

**ç›®çš„**ï¼šæ ¹æ®æ¶ˆæ¯ç±»åˆ«é€‰æ‹©ä¸åŒçš„å‘é€ç­–ç•¥

```java
public interface MessageProducer {
    boolean sendAsync(UnifiedMessage message);
    boolean sendSync(UnifiedMessage message);
    MessageCategory getSupportedCategory();
}

// å…·ä½“ç­–ç•¥
- P2PMessageProducer        (P2Pæ¶ˆæ¯)
- GroupMessageProducer      (ç¾¤èŠæ¶ˆæ¯)
- SystemNotificationProducer (ç³»ç»Ÿé€šçŸ¥)
- OrganizationNotificationProducer (ç»„ç»‡é€šçŸ¥)
- BusinessNotificationProducer (ä¸šåŠ¡é€šçŸ¥)
```

**ä¼˜ç‚¹**ï¼š
- âœ… æ˜“äºæ‰©å±•æ–°çš„æ¶ˆæ¯ç±»å‹
- âœ… æ¯ä¸ªç­–ç•¥ç‹¬ç«‹ï¼ŒèŒè´£å•ä¸€
- âœ… æ¶ˆé™¤å¤§é‡if-elseåˆ¤æ–­

### 2. é—¨é¢æ¨¡å¼ï¼ˆUnifiedMessageServiceï¼‰

**ç›®çš„**ï¼šå¯¹å¤–æä¾›ç»Ÿä¸€çš„æ¶ˆæ¯å‘é€æ¥å£ï¼Œéšè—å†…éƒ¨å¤æ‚æ€§

```java
@Service
public class UnifiedMessageService {
    // ç»Ÿä¸€å…¥å£
    public boolean sendMessage(UnifiedMessage message);

    // ä¾¿æ·æ–¹æ³•
    public boolean sendP2PMessage(...);
    public boolean sendGroupMessage(...);
    public boolean sendSystemNotification(...);
    ...
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç®€åŒ–å®¢æˆ·ç«¯è°ƒç”¨
- âœ… å°è£…å†…éƒ¨å¤æ‚é€»è¾‘
- âœ… ä¾¿äºç»Ÿä¸€ç®¡ç†å’Œç›‘æ§

### 3. è´£ä»»é“¾æ¨¡å¼ï¼ˆMessageHandlerï¼‰

**ç›®çš„**ï¼šæ¶ˆæ¯æ¶ˆè´¹æ—¶ï¼ŒæŒ‰é¡ºåºæ‰§è¡Œå¤šä¸ªå¤„ç†æ­¥éª¤

```java
public interface MessageHandler {
    boolean handle(UnifiedMessage message);
    void setNext(MessageHandler next);
}

// è´£ä»»é“¾
WebSocketPushHandler â†’ DatabasePersistHandler â†’ RedisCacheHandler â†’ OfflineMessageHandler
```

**ä¼˜ç‚¹**ï¼š
- âœ… è§£è€¦å¤„ç†æ­¥éª¤
- âœ… æ˜“äºå¢åˆ å¤„ç†å™¨
- âœ… çµæ´»è°ƒæ•´å¤„ç†é¡ºåº

### 4. å»ºé€ è€…æ¨¡å¼ï¼ˆUnifiedMessageï¼‰

**ç›®çš„**ï¼šä¼˜é›…åœ°æ„å»ºå¤æ‚çš„æ¶ˆæ¯å¯¹è±¡

```java
UnifiedMessage message = UnifiedMessage.builder()
    .category(MessageCategory.P2P)
    .messageType("CHAT")
    .fromId(fromUserId)
    .toId(toUserId)
    .content(content)
    .priority(MessagePriority.NORMAL)
    .build();
```

**ä¼˜ç‚¹**ï¼š
- âœ… ä»£ç å¯è¯»æ€§é«˜
- âœ… æ”¯æŒé“¾å¼è°ƒç”¨
- âœ… çµæ´»è®¾ç½®å±æ€§

---

## æ ¸å¿ƒåŠŸèƒ½

### 1. ç»Ÿä¸€æ¶ˆæ¯æ¨¡å‹

```java
@Data
@Builder
public class UnifiedMessage implements Serializable {
    // æ¶ˆæ¯å…ƒæ•°æ®
    private String messageId;
    private MessageCategory category;
    private String messageType;
    private MessagePriority priority;

    // å‘é€æ–¹ä¿¡æ¯
    private Long fromId;
    private String fromType;
    private String fromName;

    // æ¥æ”¶æ–¹ä¿¡æ¯
    private Long toId;
    private String toType;
    private List<Long> toIds;

    // æ¶ˆæ¯å†…å®¹
    private String title;
    private String content;
    private String summary;

    // å…³è”ä¸šåŠ¡ä¿¡æ¯
    private Long relatedId;
    private String relatedType;

    // æ‰©å±•å­—æ®µ
    private Map<String, Object> extraData;
    ...
}
```

### 2. æ¶ˆæ¯å¹‚ç­‰æ€§

```java
@Service
public class MessageIdempotentService {
    // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å¤„ç†
    public boolean isMessageProcessed(String messageId);

    // æ ‡è®°æ¶ˆæ¯ä¸ºå·²å¤„ç†
    public boolean markMessageAsProcessed(String messageId);
}
```

**å®ç°åŸç†**ï¼š
- ä½¿ç”¨ Redis è®°å½•å·²å¤„ç†çš„æ¶ˆæ¯ID
- Keyæ ¼å¼ï¼š`message:processed:{messageId}`
- é»˜è®¤è¿‡æœŸæ—¶é—´ï¼š1å°æ—¶

### 3. æ­»ä¿¡é˜Ÿåˆ—

```java
@Service
public class DeadLetterQueueService {
    // å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
    public void sendToDeadLetterQueue(UnifiedMessage message, String reason);
}
```

**è§¦å‘æ¡ä»¶**ï¼š
- æ¶ˆæ¯å¤„ç†å¤±è´¥
- è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°
- æ¶ˆæ¯æ ¼å¼é”™è¯¯

### 4. ç¦»çº¿æ¶ˆæ¯å¤„ç†

```java
@Component
public class OfflineMessageHandler extends AbstractMessageHandler {
    @Override
    protected boolean doHandle(UnifiedMessage message) {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨çº¿
        boolean isOnline = isUserOnline(message.getToId());

        if (!isOnline) {
            // å­˜å‚¨åˆ°Redis
            redisCache.addOfflineMessage(message.getToId(), message, 7);
        }
        return true;
    }
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… è‡ªåŠ¨æ£€æµ‹åœ¨çº¿çŠ¶æ€
- âœ… ç¦»çº¿æ¶ˆæ¯ä¿ç•™7å¤©
- âœ… ç”¨æˆ·ä¸Šçº¿è‡ªåŠ¨æ¨é€

---

## ä»£ç ç»“æ„

```
cni-alumni-core/
â”œâ”€â”€ alumni-common/
â”‚   â”œâ”€â”€ enums/
â”‚   â”‚   â”œâ”€â”€ MessageCategory.java         (æ¶ˆæ¯ç±»åˆ«æšä¸¾)
â”‚   â”‚   â”œâ”€â”€ MessagePriority.java         (æ¶ˆæ¯ä¼˜å…ˆçº§æšä¸¾)
â”‚   â”‚   â””â”€â”€ NotificationType.java        (é€šçŸ¥ç±»å‹æšä¸¾)
â”‚   â”œâ”€â”€ model/
â”‚   â”‚   â””â”€â”€ UnifiedMessage.java          (ç»Ÿä¸€æ¶ˆæ¯æ¨¡å‹)
â”‚   â””â”€â”€ constant/
â”‚       â””â”€â”€ KafkaTopicConstants.java     (Kafka Topicå¸¸é‡)
â”‚
â”œâ”€â”€ alumni-service/user-service/
â”‚   â””â”€â”€ message/
â”‚       â”œâ”€â”€ MessageProducer.java         (ç”Ÿäº§è€…æ¥å£)
â”‚       â”œâ”€â”€ AbstractMessageProducer.java (ç”Ÿäº§è€…æŠ½è±¡ç±»)
â”‚       â”œâ”€â”€ UnifiedMessageService.java   (ç»Ÿä¸€æ¶ˆæ¯æœåŠ¡)
â”‚       â”‚
â”‚       â”œâ”€â”€ impl/                        (ç”Ÿäº§è€…å®ç°)
â”‚       â”‚   â”œâ”€â”€ P2PMessageProducer.java
â”‚       â”‚   â”œâ”€â”€ GroupMessageProducer.java
â”‚       â”‚   â”œâ”€â”€ SystemNotificationProducer.java
â”‚       â”‚   â”œâ”€â”€ OrganizationNotificationProducer.java
â”‚       â”‚   â””â”€â”€ BusinessNotificationProducer.java
â”‚       â”‚
â”‚       â”œâ”€â”€ handler/                     (æ¶ˆè´¹è€…å¤„ç†å™¨)
â”‚       â”‚   â”œâ”€â”€ MessageHandler.java      (å¤„ç†å™¨æ¥å£)
â”‚       â”‚   â”œâ”€â”€ AbstractMessageHandler.java
â”‚       â”‚   â”œâ”€â”€ WebSocketPushHandler.java
â”‚       â”‚   â”œâ”€â”€ DatabasePersistHandler.java
â”‚       â”‚   â”œâ”€â”€ RedisCacheHandler.java
â”‚       â”‚   â””â”€â”€ OfflineMessageHandler.java
â”‚       â”‚
â”‚       â”œâ”€â”€ consumer/                    (æ¶ˆè´¹è€…)
â”‚       â”‚   â””â”€â”€ UnifiedMessageConsumer.java
â”‚       â”‚
â”‚       â””â”€â”€ reliability/                 (å¯é æ€§ä¿éšœ)
â”‚           â”œâ”€â”€ MessageIdempotentService.java
â”‚           â””â”€â”€ DeadLetterQueueService.java
â”‚
â””â”€â”€ alumni-config/
    â””â”€â”€ kafka/topic/
        â””â”€â”€ UnifiedMessageTopicConfig.java (Topicé…ç½®)
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. å¼‚æ­¥å‘é€

```java
// é»˜è®¤ä½¿ç”¨å¼‚æ­¥å‘é€
kafkaUtils.sendAsync(topic, key, message);
```

**ä¼˜ç‚¹**ï¼šä¸é˜»å¡ä¸»çº¿ç¨‹ï¼Œæå‡ååé‡

### 2. æ‰¹é‡å¤„ç†

```java
// æ‰¹é‡å‘é€æ¶ˆæ¯
public int batchSendMessages(List<UnifiedMessage> messages);
```

**åœºæ™¯**ï¼šç»„ç»‡é€šçŸ¥ã€ç³»ç»Ÿå…¬å‘Šç­‰

### 3. æ¶ˆæ¯åˆ†åŒº

- P2Pæ¶ˆæ¯ï¼šæŒ‰ç”¨æˆ·IDåˆ†åŒº
- ç¾¤èŠæ¶ˆæ¯ï¼šæŒ‰ç¾¤ç»„IDåˆ†åŒº
- é€šçŸ¥æ¶ˆæ¯ï¼šæŒ‰ç”¨æˆ·IDåˆ†åŒº

**ä¼˜ç‚¹**ï¼šæå‡å¹¶å‘å¤„ç†èƒ½åŠ›

### 4. Redisç¼“å­˜

- æœªè¯»æ¶ˆæ¯è®¡æ•°
- åœ¨çº¿ç”¨æˆ·çŠ¶æ€
- ç¦»çº¿æ¶ˆæ¯é˜Ÿåˆ—
- æœ€è¿‘æ¶ˆæ¯åˆ—è¡¨

---

## ç›‘æ§å’Œè¿ç»´

### 1. å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡                  | è¯´æ˜                |
| --------------------- | ------------------- |
| æ¶ˆæ¯å‘é€æˆåŠŸç‡        | > 99.9%             |
| æ¶ˆæ¯æ¶ˆè´¹å»¶è¿Ÿ(P95)     | < 100ms             |
| æ­»ä¿¡é˜Ÿåˆ—æ¶ˆæ¯æ•°        | ç›‘æ§å¼‚å¸¸å¢é•¿        |
| Kafkaæ¶ˆæ¯ç§¯å‹         | ç›‘æ§æ¶ˆè´¹å»¶è¿Ÿ        |
| WebSocketè¿æ¥æ•°       | ç›‘æ§åœ¨çº¿ç”¨æˆ·æ•°      |

### 2. æ—¥å¿—è®°å½•

```java
log.info("[MessageProducer] æ¶ˆæ¯å‘é€æˆåŠŸ - MessageId: {}, Category: {}");
log.warn("[MessageConsumer] æ¶ˆæ¯å¤„ç†å¤±è´¥ - MessageId: {}, Reason: {}");
log.error("[DeadLetterQueue] æ¶ˆæ¯å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ— - MessageId: {}");
```

### 3. å‘Šè­¦è§„åˆ™

- æ­»ä¿¡é˜Ÿåˆ—æ¶ˆæ¯æ•° > 100
- Kafkaæ¶ˆæ¯ç§¯å‹ > 10000
- æ¶ˆæ¯å¤„ç†å¤±è´¥ç‡ > 1%
- WebSocketè¿æ¥æ•°å¼‚å¸¸æ³¢åŠ¨

---

## æœªæ¥è§„åˆ’

### çŸ­æœŸï¼ˆ1-3ä¸ªæœˆï¼‰

- [ ] æ·»åŠ æ¶ˆæ¯ä¼˜å…ˆçº§é˜Ÿåˆ—
- [ ] å®ç°æ¶ˆæ¯å»¶è¿Ÿå‘é€
- [ ] æ”¯æŒæ¶ˆæ¯æ’¤å›åŠŸèƒ½
- [ ] å®Œå–„ç›‘æ§é¢æ¿

### ä¸­æœŸï¼ˆ3-6ä¸ªæœˆï¼‰

- [ ] æ”¯æŒæ¶ˆæ¯æ¨¡æ¿å¼•æ“
- [ ] å®ç°æ¶ˆæ¯æ¨é€æ¸ é“æ‰©å±•ï¼ˆé‚®ä»¶ã€çŸ­ä¿¡ï¼‰
- [ ] ä¼˜åŒ–æ¶ˆæ¯æ£€ç´¢åŠŸèƒ½
- [ ] æ·»åŠ æ¶ˆæ¯ç»Ÿè®¡åˆ†æ

### é•¿æœŸï¼ˆ6-12ä¸ªæœˆï¼‰

- [ ] æ”¯æŒæ¶ˆæ¯åŠ å¯†
- [ ] å®ç°è·¨æ•°æ®ä¸­å¿ƒéƒ¨ç½²
- [ ] AIæ™ºèƒ½æ¶ˆæ¯è¿‡æ»¤
- [ ] å®Œæ•´çš„æ¶ˆæ¯å®¡è®¡ç³»ç»Ÿ

---

## æ€»ç»“

### ä¼˜åŒ–æˆæœ

âœ… **ç»Ÿä¸€æ¶æ„** - æ‰€æœ‰æ¶ˆæ¯ç±»å‹ç»Ÿä¸€ç®¡ç†
âœ… **ä¼ä¸šçº§æ ‡å‡†** - åº”ç”¨å¤šç§è®¾è®¡æ¨¡å¼ï¼Œä»£ç è´¨é‡å¤§å¹…æå‡
âœ… **é«˜å¯ç”¨æ€§** - æ¶ˆæ¯å¹‚ç­‰ã€é‡è¯•ã€æ­»ä¿¡é˜Ÿåˆ—ç­‰æœºåˆ¶å®Œå–„
âœ… **é«˜æ€§èƒ½** - å¼‚æ­¥å¤„ç†ã€æ‰¹é‡æ“ä½œã€ç¼“å­˜ä¼˜åŒ–
âœ… **æ˜“æ‰©å±•** - æ–°å¢æ¶ˆæ¯ç±»å‹åªéœ€æ·»åŠ ç­–ç•¥å®ç°
âœ… **æ˜“ç»´æŠ¤** - æ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼ŒèŒè´£æ˜ç¡®

### æŠ€æœ¯äº®ç‚¹

1. **ç­–ç•¥æ¨¡å¼** - çµæ´»æ”¯æŒå¤šç§æ¶ˆæ¯ç±»å‹
2. **è´£ä»»é“¾æ¨¡å¼** - è§£è€¦æ¶ˆæ¯å¤„ç†æµç¨‹
3. **é—¨é¢æ¨¡å¼** - ç®€åŒ–APIè°ƒç”¨
4. **æ¶ˆæ¯å¹‚ç­‰æ€§** - ä¿è¯æ¶ˆæ¯ä¸é‡å¤æ¶ˆè´¹
5. **æ­»ä¿¡é˜Ÿåˆ—** - å¤±è´¥æ¶ˆæ¯æœ‰è¿¹å¯æŸ¥
6. **ç¦»çº¿æ¶ˆæ¯** - è‡ªåŠ¨å­˜å‚¨å’Œæ¨é€

---

**Â© 2025 CMSWE Alumni Platform. All Rights Reserved.**
