<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¾¤ç”»åƒ - æŒç»­ç²’å­æµæ¼”ç¤º</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* --- åŸºç¡€æ ·å¼ä¿æŒä¸å˜ --- */
        body { margin: 0; background-color: #020617; font-family: 'Inter', sans-serif; overflow: hidden; color: #fff; width: 100vw; height: 100vh; }
        .grid-bg {
            position: absolute; width: 200%; height: 200%;
            background-image: linear-gradient(rgba(34, 211, 238, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(34, 211, 238, 0.03) 1px, transparent 1px);
            background-size: 60px 60px; pointer-events: none; z-index: 0;
            transform: perspective(800px) rotateX(20deg) translateY(-150px);
        }
        #chart-container { position: absolute; width: 100%; height: 100%; z-index: 1; }

        /* æ ·å¼å¾®è°ƒ */
        .node text { font-size: 10px; fill: #94a3b8; pointer-events: none; text-shadow: 0 2px 4px rgba(0,0,0,0.8); transition: opacity 0.3s; }
        .link { stroke: #1e293b; stroke-opacity: 0.6; transition: all 0.3s; }

        /* é«˜äº®æ€ */
        .node.active circle.core { stroke: #fff; stroke-width: 3px; filter: drop-shadow(0 0 10px rgba(34, 211, 238, 0.8)); }
        .node.dimmed { opacity: 0.1; }
        .link.dimmed { opacity: 0.05; }
        .link.active { stroke: #22d3ee; stroke-opacity: 0.6; stroke-width: 1.5px; filter: drop-shadow(0 0 5px rgba(34, 211, 238, 0.3)); }

        /* ç²’å­æ ·å¼ - å¢åŠ å‘å…‰æ•ˆæœ */
        .flow-particle {
            fill: #fff;
            filter: drop-shadow(0 0 4px #22d3ee); /* ç²’å­è‡ªå¸¦éœ“è™¹å…‰æ™• */
            pointer-events: none;
        }

        /* åº•éƒ¨é¢æ¿æ ·å¼ */
        .bottom-panel {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px 24px 0 0;
            padding: 24px; box-sizing: border-box; transform: translateY(110%);
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); z-index: 10;
        }
        .bottom-panel.show { transform: translateY(0); }
        .panel-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .panel-title h2 { margin: 0; font-size: 20px; color: #f1f5f9; }
        .close-btn { background: rgba(255,255,255,0.1); border: none; color: #fff; width: 30px; height: 30px; border-radius: 50%; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        .stat-num { font-size: 24px; font-weight: 700; color: #22d3ee; font-family: monospace; }
        .label { font-size: 12px; color: #64748b; margin-top: 4px; display: block; }

        /* ä¸ºäº†æ¼”ç¤ºï¼Œç®€å•å¸ƒå±€ */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .card-bg { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; }

    </style>
</head>
<body>

<div class="grid-bg"></div>
<div id="chart-container"></div>

<div class="bottom-panel" id="detail-panel">
    <div class="panel-header">
        <div class="panel-title"><h2 id="p-name">åç§°</h2></div>
        <button class="close-btn" onclick="closePanel()">Ã—</button>
    </div>
    <div class="grid-2">
        <div class="card-bg">
            <div class="stat-num" id="p-count">0</div>
            <span class="label">å…³è”çƒ­åº¦</span>
        </div>
        <div class="card-bg">
            <div class="stat-num" style="color:#a78bfa">Top 1</div>
            <span class="label">æ’åæƒ…å†µ</span>
        </div>
    </div>
</div>

<script>
    const nodesData = [
        { id: "00å", group: 1, val: 55 }, { id: "æé’±", group: 2, val: 45 }, { id: "èººå¹³", group: 3, val: 25 },
        { id: "å¹¿ä¸œ", group: 1, val: 40 }, { id: "ç¨‹åºå‘˜", group: 1, val: 50 }, { id: "æ’¸çŒ«", group: 2, val: 30 },
        { id: "æ—©Cæ™šA", group: 2, val: 35 }, { id: "äºŒæ¬¡å…ƒ", group: 2, val: 42 }, { id: "æ¸¸æˆ", group: 2, val: 38 },
        { id: "å…»ç”Ÿ", group: 3, val: 20 }, { id: "è„±å‘", group: 3, val: 15 }, { id: "å’–å•¡", group: 3, val: 22 },
        { id: "åŸºé‡‘", group: 3, val: 18 }, { id: "åŠ ç­", group: 3, val: 12 }, { id: "å¤œå®µ", group: 3, val: 16 }
    ];

    const linksData = [
        { source: "00å", target: "äºŒæ¬¡å…ƒ" }, { source: "00å", target: "æ¸¸æˆ" }, { source: "00å", target: "æé’±" }, { source: "00å", target: "èººå¹³" },
        { source: "00å", target: "æ—©Cæ™šA" }, { source: "ç¨‹åºå‘˜", target: "è„±å‘" }, { source: "ç¨‹åºå‘˜", target: "åŠ ç­" }, { source: "ç¨‹åºå‘˜", target: "æé’±" },
        { source: "ç¨‹åºå‘˜", target: "å’–å•¡" }, { source: "å¹¿ä¸œ", target: "æ—©Cæ™šA" }, { source: "å¹¿ä¸œ", target: "å¤œå®µ" }, { source: "å¹¿ä¸œ", target: "æé’±" },
        { source: "æé’±", target: "åŸºé‡‘" }, { source: "æ’¸çŒ«", target: "èººå¹³" }, { source: "äºŒæ¬¡å…ƒ", target: "æ¸¸æˆ" }, { source: "å…»ç”Ÿ", target: "æ—©Cæ™šA" }
    ];

    const width = window.innerWidth;
    const height = window.innerHeight;
    const svg = d3.select("#chart-container").append("svg").attr("width", width).attr("height", height).attr("viewBox", [0, 0, width, height]);

    const colorScale = d3.scaleOrdinal().domain([1, 2, 3]).range(["#22d3ee", "#a78bfa", "#94a3b8"]);
    const sizeScale = d3.scaleSqrt().domain([0, 60]).range([8, 30]);

    const g = svg.append("g");
    const zoom = d3.zoom().scaleExtent([0.5, 3]).on("zoom", (e) => g.attr("transform", e.transform));
    svg.call(zoom);

    // --- ç‰©ç†å¼•æ“ ---
    const simulation = d3.forceSimulation(nodesData)
        .force("link", d3.forceLink(linksData).id(d => d.id).distance(110))
        .force("charge", d3.forceManyBody().strength(-350))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collide", d3.forceCollide().radius(d => sizeScale(d.val) + 10));

    // --- ç»˜åˆ¶ ---
    const link = g.append("g").selectAll(".link")
        .data(linksData).join("line")
        .attr("class", "link").attr("stroke-width", 1);

    const node = g.append("g").selectAll(".node")
        .data(nodesData).join("g").attr("class", "node")
        .call(d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended));

    node.append("circle").attr("r", d => sizeScale(d.val) * 1.5).attr("fill", d => colorScale(d.group)).attr("opacity", 0.1); // å…‰æ™•
    node.append("circle").attr("class", "core").attr("r", d => sizeScale(d.val)).attr("fill", "#020617").attr("stroke", d => colorScale(d.group)).attr("stroke-width", 2);
    node.append("text").text(d => d.id).attr("dy", d => sizeScale(d.val) + 14).attr("text-anchor", "middle");

    simulation.on("tick", () => {
        link.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
        node.attr("transform", d => `translate(${d.x},${d.y})`);
        // æ³¨æ„ï¼šè¿™é‡Œä¸å†è°ƒç”¨ç²’å­ç”Ÿæˆå‡½æ•°
    });

    // --- äº¤äº’ ---
    node.on("click", (event, d) => {
        event.stopPropagation();
        // é«˜äº®é€»è¾‘
        node.classed("dimmed", n => n.id !== d.id).classed("active", n => n.id === d.id);
        const neighbors = linksData.filter(l => l.source.id === d.id || l.target.id === d.id);
        link.classed("dimmed", true).classed("active", false);
        link.filter(l => l.source.id === d.id || l.target.id === d.id).classed("active", true).classed("dimmed", false);
        neighbors.forEach(l => {
            const nNode = l.source.id === d.id ? l.target : l.source;
            node.filter(n => n.id === nNode.id).classed("dimmed", false);
        });
        // è¿é•œ
        const scale = 2;
        svg.transition().duration(600).call(zoom.transform, d3.zoomIdentity.translate(-d.x * scale + width / 2, -d.y * scale + height * 0.4).scale(scale));
        // å¼¹çª—
        document.getElementById("p-name").innerText = d.id;
        document.getElementById("p-count").innerText = Math.floor(Math.random() * 1000 + 500);
        document.getElementById("detail-panel").classList.add("show");
    });

    window.closePanel = function() {
        document.getElementById("detail-panel").classList.remove("show");
        node.classed("dimmed", false).classed("active", false);
        link.classed("dimmed", false).classed("active", false);
        svg.transition().duration(600).call(zoom.transform, d3.zoomIdentity.translate(width/2, height/2).scale(1));
    };
    svg.on("click", () => window.closePanel());

    // --- ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šç‹¬ç«‹çš„ç²’å­å¼•æ“ (Independent Particle Engine) ---
    // å•ç‹¬åˆ›å»ºä¸€ä¸ªå›¾å±‚ç”¨äºç”»ç²’å­ï¼Œé¿å…å½±å“å…¶ä»–å…ƒç´ 
    const particleLayer = g.append("g").attr("class", "particle-layer");

    // æŒç»­è®¡æ—¶å™¨ï¼šå®Œå…¨ç‹¬ç«‹äºç‰©ç†å¼•æ“
    // è®¾ç½®é—´éš” 150ms ç”Ÿæˆä¸€ä¸ªç²’å­ (å¯ä»¥è°ƒå°æ•°å­—è®©ç²’å­æ›´å¯†é›†)
    d3.interval(() => {
        // å¦‚æœé¡µé¢è¢«éšè—ï¼ˆç”¨æˆ·åˆ‡æ¢äº†Tabï¼‰ï¼Œæš‚åœç”Ÿæˆä»¥çœç”µ
        if(document.hidden) return;

        // 1. éšæœºé€‰ä¸€æ¡çº¿
        if (linksData.length === 0) return;
        const l = linksData[Math.floor(Math.random() * linksData.length)];

        // 2. éšæœºå†³å®šç²’å­çš„æ–¹å‘ (source->target æˆ– target->source)
        const reverse = Math.random() > 0.5;
        const startNode = reverse ? l.target : l.source;
        const endNode = reverse ? l.source : l.target;

        // 3. ç”Ÿæˆç²’å­
        const pSize = Math.random() * 2 + 1.5; // éšæœºå¤§å° 1.5px ~ 3.5px
        const pSpeed = Math.random() * 500 + 1000; // éšæœºé€Ÿåº¦ 1000ms ~ 1500ms

        const particle = particleLayer.append("circle")
            .attr("class", "flow-particle")
            .attr("r", pSize)
            .attr("cx", startNode.x)
            .attr("cy", startNode.y);

        // 4. å‘å°„åŠ¨ç”»
        particle.transition()
            .duration(pSpeed)
            .ease(d3.easeLinear) // åŒ€é€Ÿè¿åŠ¨æ›´åƒæ•°æ®æµ
            .attrTween("cx", () => d3.interpolateNumber(startNode.x, endNode.x))
            .attrTween("cy", () => d3.interpolateNumber(startNode.y, endNode.y))
            .remove(); // åŠ¨ç”»ç»“æŸé”€æ¯DOMï¼Œé˜²æ­¢å†…å­˜æ³„æ¼

    }, 150);

    function dragstarted(event, d) { if (!event.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
    function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
    function dragended(event, d) { if (!event.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }

</script>
</body>
</html>