<!-- pages/audit/merchant/shop/shop.wxml -->
<!-- 自定义导航栏 -->
<custom-nav-bar title="店铺管理" showBack="{{true}}"></custom-nav-bar>

<view class="shop-management-page">
  <!-- 选择商家 -->
  <view class="form-card">
    <view class="form-title">店铺管理</view>

    <!-- 选择商家 -->
    <view class="form-item">
      <text class="form-label">选择商家</text>
      <view class="merchant-selector" bindtap="showMerchantSelector">
        <text class="selector-label">{{selectedMerchantName || '请选择商家'}}</text>
        <text class="selector-arrow">▼</text>
      </view>
    </view>
  </view>
  
  <!-- 店铺列表 -->
  <view class="form-card" style="margin-top: 20rpx;">
    <view class="form-title">店铺列表</view>
    <!-- 加载状态 -->
    <view class="loading-state" wx:if="{{shopLoading}}">
      <text class="loading-text">加载中...</text>
    </view>
    
    <!-- 空状态 -->
    <view class="empty-state" wx:elif="{{shopList.length === 0}}">
      <text class="empty-text">暂无店铺数据</text>
    </view>
    
    <!-- 店铺列表 -->
    <view class="shop-item" wx:for="{{shopList}}" wx:key="shopId">
      <view class="shop-info">
        <view class="shop-name">{{item.shopName}}</view>
        <view class="shop-type">{{item.shopType === 1 ? '总店' : '分店'}}</view>
      </view>
      <view class="shop-address">{{item.province}}{{item.city}}{{item.district}}{{item.address}}</view>
      <view class="shop-phone">{{item.phone}}</view>
      <view class="shop-actions">
        <button class="edit-btn" bindtap="showEditShopModal" data-shop-id="{{item.shopId}}">编辑</button>
        <button class="delete-btn" bindtap="showDeleteConfirm" data-shop-id="{{item.shopId}}">删除</button>
      </view>
    </view>
  </view>
  
  <!-- 悬浮+号按钮 -->
  <view class="add-shop-btn" bindtap="showCreateShopModal">
    +
  </view>
</view>

<!-- 创建店铺弹窗 -->
<view class="modal-overlay" wx:if="{{showModal}}" bindtap="hideCreateShopModal"></view>
<view class="modal-container" wx:if="{{showModal}}">
  <view class="modal-header">
    <text class="modal-title">{{operationType === 'edit' ? '编辑店铺' : '创建店铺'}}</text>
    <view class="modal-close" bindtap="hideCreateShopModal">×</view>
  </view>
  <view class="modal-content">
    <form bindsubmit="submitShopForm">
      <!-- 所属商户 -->
      <view class="form-item">
        <text class="form-label">所属商户 <text class="required">*</text></text>
        <view class="merchant-selector" bindtap="showMerchantSelector">
          <text class="selector-label">{{selectedMerchantName || '请选择商户'}}</text>
          <text class="selector-arrow">▼</text>
        </view>
      </view>
      
      <!-- 店铺名称 -->
      <view class="form-item">
        <text class="form-label">店铺名称 <text class="required">*</text></text>
        <input class="form-input" name="shopName" placeholder="请输入店铺名称" value="{{formData.shopName}}" bindinput="onInputChange" data-field="shopName" />
      </view>
      
      <!-- 店铺类型 -->
      <view class="form-item">
        <text class="form-label">店铺类型 <text class="required">*</text></text>
        <view class="radio-group">
          <label class="radio-item">
            <radio value="1" checked="{{formData.shopType === 1}}" bindtap="onRadioChange" data-field="shopType" data-value="1" />总店
          </label>
          <label class="radio-item">
            <radio value="2" checked="{{formData.shopType === 2}}" bindtap="onRadioChange" data-field="shopType" data-value="2" />分店
          </label>
        </view>
      </view>
      
      <!-- 省份 -->
      <view class="form-item">
        <text class="form-label">省份 <text class="required">*</text></text>
        <input class="form-input" name="province" placeholder="请输入省份" value="{{formData.province}}" bindinput="onInputChange" data-field="province" />
      </view>
      
      <!-- 城市 -->
      <view class="form-item">
        <text class="form-label">城市 <text class="required">*</text></text>
        <input class="form-input" name="city" placeholder="请输入城市" value="{{formData.city}}" bindinput="onInputChange" data-field="city" />
      </view>
      
      <!-- 区县 -->
      <view class="form-item">
        <text class="form-label">区县 <text class="required">*</text></text>
        <input class="form-input" name="district" placeholder="请输入区县" value="{{formData.district}}" bindinput="onInputChange" data-field="district" />
      </view>
      
      <!-- 详细地址 -->
      <view class="form-item">
        <text class="form-label">详细地址 <text class="required">*</text></text>
        <input class="form-input" name="address" placeholder="请输入详细地址" value="{{formData.address}}" bindinput="onInputChange" data-field="address" />
      </view>
      
      <!-- 位置选择 -->
      <view class="form-item">
        <text class="form-label">店铺位置 <text class="required">*</text></text>
        <view class="location-selector">
          <input class="form-input location-input" placeholder="请选择店铺位置" value="{{formData.locationName}}" disabled />
          <button class="select-location-btn" bindtap="selectLocation">选择位置</button>
        </view>
      </view>
      
      <!-- 店铺电话 -->
      <view class="form-item">
        <text class="form-label">店铺电话</text>
        <input class="form-input" name="phone" type="number" placeholder="请输入店铺电话" value="{{formData.phone}}" bindinput="onInputChange" data-field="phone" />
      </view>
      
      <!-- 营业时间 -->
      <view class="form-item">
        <text class="form-label">营业时间</text>
        <input class="form-input" name="businessHours" placeholder="请输入营业时间" value="{{formData.businessHours}}" bindinput="onInputChange" data-field="businessHours" />
      </view>
      
      <!-- 店铺图片 -->
      <view class="form-item">
        <text class="form-label">上传店铺背景图</text>
        <view class="image-upload-container">
          <view class="uploaded-images">
            <view class="uploaded-image" wx:for="{{uploadedImages}}" wx:key="index">
              <image src="{{item}}" mode="aspectFill" class="image-preview" />
              <view class="image-delete" bindtap="deleteImage" data-index="{{index}}">×</view>
            </view>
          </view>
          <button class="upload-btn" bindtap="chooseImage" type="primary" size="mini">上传图片</button>
        </view>
      </view>
      
      <!-- 店铺简介 -->
      <view class="form-item">
        <text class="form-label">店铺简介</text>
        <textarea class="form-textarea" name="description" placeholder="请输入店铺简介" value="{{formData.description}}" bindinput="onInputChange" data-field="description" />
      </view>
      
      <!-- 店铺状态 -->
      <view class="form-item">
        <text class="form-label">店铺状态</text>
        <view class="radio-group">
          <label class="radio-item">
            <radio value="0" checked="{{formData.status === 0}}" bindtap="onRadioChange" data-field="status" data-value="0" />停业
          </label>
          <label class="radio-item">
            <radio value="1" checked="{{formData.status === 1}}" bindtap="onRadioChange" data-field="status" data-value="1" />营业中
          </label>
          <label class="radio-item">
            <radio value="2" checked="{{formData.status === 2}}" bindtap="onRadioChange" data-field="status" data-value="2" />装修中
          </label>
        </view>
      </view>
      
      <!-- 提交按钮 -->
      <view class="form-actions">
        <button class="btn-cancel" bindtap="hideCreateShopModal">取消</button>
        <button class="btn-submit" form-type="submit" loading="{{submitting}}">提交</button>
      </view>
    </form>
  </view>
</view>

<!-- 商户选择器弹窗 -->
<view class="merchant-picker" wx:if="{{showMerchantPicker}}">
  <view class="picker-overlay" bindtap="cancelMerchantSelect"></view>
  <view class="picker-content">
    <view class="picker-header">
      <text class="picker-title">选择商户</text>
      <text class="picker-cancel" bindtap="cancelMerchantSelect">取消</text>
    </view>
    <view class="picker-list">
      <view 
        class="picker-item" 
        wx:for="{{merchantList}}" 
        wx:key="merchantId"
        data-merchant-id="{{item.merchantId + ''}}"
        data-merchant-name="{{item.merchantName}}"
        bindtap="selectMerchant"
      >
        <text class="item-name">{{item.merchantName}}</text>
        <text class="item-check" wx:if="{{selectedMerchantId == item.merchantId}}">✓</text>
      </view>
      <view class="picker-empty" wx:if="{{merchantList.length === 0}}">
        <text>暂无商户数据</text>
      </view>
    </view>
  </view>
</view>