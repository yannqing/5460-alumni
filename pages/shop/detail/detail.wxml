<!--pages/shop/detail/detail.wxml-->
<view class="shop-detail-page">
  <view wx:if="{{loading}}" class="loading-wrap">
    <view class="loading">åŠ è½½ä¸­...</view>
  </view>

  <view wx:else>
    <!-- å¤šå›¾è½®æ’­ -->
    <swiper class="shop-swiper" indicator-dots="{{true}}" autoplay="{{true}}" interval="{{3000}}" duration="{{500}}" circular="{{true}}">
      <swiper-item wx:for="{{shopInfo.gallery}}" wx:key="*this">
        <image class="swiper-image" src="{{item}}" mode="aspectFill"></image>
      </swiper-item>
    </swiper>

    <!-- åŸºç¡€ä¿¡æ¯å¡ç‰‡ -->
    <view class="card basic-info-card">
      <!-- å³ä¸Šè§’æ“ä½œå›¾æ ‡ -->
      <view class="card-action-icons">
        <view class="action-icon-item" bindtap="toggleFavorite">
          <text class="icon-text {{shopInfo.isFavorited ? 'favorited' : ''}}">{{shopInfo.isFavorited ? 'â¤ï¸' : 'ğŸ¤'}}</text>
        </view>
        <view class="action-icon-item" bindtap="contactShop">
          <text class="icon-text">ğŸ’¬</text>
        </view>
      </view>
      <view class="shop-header">
        <view class="shop-avatar-row">
          <image class="shop-avatar" src="{{shopInfo.avatar}}" mode="aspectFill"></image>
          <view class="shop-info-column">
            <view class="shop-name-row">
              <text class="shop-name">{{shopInfo.name}}</text>
              <view wx:if="{{shopInfo.certifiedAssociation}}" class="certified-badge-yellow" bindtap="viewAssociationDetail">
                {{shopInfo.certifiedAssociation.name}}
              </view>
            </view>
            <view class="shop-rating-row">
              <text class="rating-text">â­ {{shopInfo.rating}}</text>
              <text class="rating-desc">è¯„åˆ†</text>
              <text class="divider">Â·</text>
              <text class="category-text">{{shopInfo.category}}</text>
            </view>
          </view>
        </view>
      </view>

      <view class="info-section">
        <view class="info-item" bindtap="openLocation">
          <image class="info-icon" src="{{iconLocation}}" mode="aspectFit"></image>
          <view class="info-content">
            <text class="info-label">åœ°å€</text>
            <text class="info-value">{{shopInfo.location}}</text>
          </view>
          <text class="nav-text">å¯¼èˆª</text>
        </view>
        <view class="info-item" bindtap="makeCall" data-phone="{{shopInfo.phone}}">
          <image class="info-icon" src="{{iconPhone}}" mode="aspectFit"></image>
          <view class="info-content">
            <text class="info-label">ç”µè¯</text>
            <text class="info-value link-text">{{shopInfo.phone}}</text>
          </view>
        </view>
        <view class="info-item" wx:if="{{shopInfo.businessHours}}">
          <image class="info-icon" src="{{iconTime}}" mode="aspectFit"></image>
          <view class="info-content">
            <text class="info-label">è¥ä¸šæ—¶é—´</text>
            <text class="info-value">{{shopInfo.businessHours}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å•†é“ºç®€ä»‹ -->
    <view class="card description-card">
      <view class="section-title">å•†é“ºç®€ä»‹</view>
      <view class="description-text">{{shopInfo.description}}</view>
    </view>

    <!-- ä¼˜æƒ åˆ¸ä¸“åŒº -->
    <view class="card coupon-section">
      <view class="section-title">ä¼˜æƒ åˆ¸ä¸“åŒº</view>
      <view class="coupon-list">
        <view class="coupon-card" wx:for="{{shopInfo.coupons}}" wx:key="id" bindtap="viewCouponDetail" data-id="{{item.id}}">
          <view class="coupon-left">
            <view class="coupon-discount">{{item.discount}}</view>
            <view class="coupon-label">ä¼˜æƒ åˆ¸</view>
          </view>
          <view class="coupon-divider"></view>
          <view class="coupon-right">
            <view class="coupon-title">{{item.title}}</view>
            <view class="coupon-desc">{{item.description}}</view>
            <view class="coupon-expire">æœ‰æ•ˆæœŸè‡³ {{item.expireDate}}</view>
          </view>
          <view class="coupon-action" catchtap="handleCoupon" data-id="{{item.id}}" data-status="{{item.status}}">
            <view 
              class="coupon-btn {{item.status === 'claimed' ? 'claimed' : item.status === 'alumni-only' ? 'disabled' : ''}}"
            >
              {{item.status === 'claimed' ? 'å·²é¢†å–å»ä½¿ç”¨' : item.status === 'alumni-only' ? 'ä»…é™æ ¡å‹' : 'é¢†å–'}}
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- åº—é“ºåŠ¨æ€/è¯é¢˜ -->
    <view class="card shop-dynamics" wx:if="{{shopInfo.dynamics && shopInfo.dynamics.length}}">
      <view class="section-title">åº—é“ºåŠ¨æ€</view>
      <view class="dynamics-list">
        <view class="dynamic-item" wx:for="{{shopInfo.dynamics}}" wx:key="id" bindtap="viewDynamicDetail" data-id="{{item.id}}">
          <image class="dynamic-image" src="{{item.image}}" mode="aspectFill" wx:if="{{item.image}}"></image>
          <view class="dynamic-content">
            <view class="dynamic-title">{{item.title}}</view>
            <view class="dynamic-desc">{{item.description}}</view>
            <view class="dynamic-meta">
              <text class="dynamic-time">{{item.time}}</text>
              <text class="dynamic-type">{{item.type === 'activity' ? 'æ´»åŠ¨' : 'æ–°å“'}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ ¡å‹è¶³è¿¹ -->
    <view class="card alumni-footprint" wx:if="{{shopInfo.recentAlumni && shopInfo.recentAlumni.length}}">
      <view class="section-title">æ ¡å‹è¶³è¿¹</view>
      <view class="footprint-desc">æœ€è¿‘æ¥è¿‡çš„æ ¡å‹</view>
      <view class="alumni-avatar-wall">
        <view 
          class="alumni-avatar-item" 
          wx:for="{{shopInfo.recentAlumni}}" 
          wx:key="id"
          bindtap="viewAlumniDetail"
          data-id="{{item.id}}"
          data-privacy="{{item.privacy}}"
        >
          <image 
            class="avatar-img {{item.privacy === 'private' ? 'blur' : ''}}" 
            src="{{item.privacy === 'private' ? defaultAvatar : item.avatar}}" 
            mode="aspectFill"
          ></image>
          <view class="avatar-info" wx:if="{{item.privacy === 'private'}}">
            <text class="privacy-text">{{item.school}}</text>
            <text class="privacy-text">{{item.grade}}çº§</text>
          </view>
          <view class="avatar-info" wx:else>
            <text class="name-text">{{item.name}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
