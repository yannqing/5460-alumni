<!--pages/shop/detail/detail.wxml-->
<custom-nav-bar showBack="{{true}}" useAuditStyle="{{true}}" auditTitle="å•†é“ºè¯¦æƒ…">
  <!-- æ¶ˆæ¯é€šçŸ¥ç»„ä»¶ -->
  <message-notification />

<view class="shop-detail-page">
  <view wx:if="{{loading}}" class="loading-wrap">
    <view class="loading">åŠ è½½ä¸­...</view>
  </view>

    <view wx:elif="{{shopInfo}}">
      <!-- å¤šå›¾è½®æ’­ -->
      <swiper class="shop-swiper" indicator-dots="{{true}}" autoplay="{{true}}" interval="{{3000}}" duration="{{500}}" circular="{{true}}">
        <swiper-item wx:for="{{shopInfo.gallery}}" wx:key="*this">
          <image class="swiper-image" src="{{item}}" mode="aspectFill"></image>
        </swiper-item>
      </swiper>

      <!-- ç™½è‰²å†…å®¹åŒºåŸŸ -->
      <view class="white-background-content">
        <!-- åŸºç¡€ä¿¡æ¯å¡ç‰‡ -->
        <view class="card basic-info-card">
          <!-- å³ä¸Šè§’æ“ä½œå›¾æ ‡ -->
          <view class="card-action-icons">
            <view class="action-icon-item" bindtap="goToChat">
              <text class="icon-text">ğŸ’¬</text>
            </view>
            <view class="action-icon-item" bindtap="toggleFavorite">
              <text class="icon-text {{shopInfo.isFavorited ? 'favorited' : ''}}">{{shopInfo.isFavorited ? 'â¤ï¸' : 'ğŸ¤'}}</text>
            </view>
          </view>
          <view class="shop-header">
            <view class="shop-avatar-row">
              <image class="shop-avatar" src="{{shopInfo.avatar}}" mode="aspectFill"></image>
              <view class="shop-info-column">
                <view class="shop-name-row">
                  <text class="shop-name">{{shopInfo.name}}</text>
                  <view wx:if="{{shopInfo.certifiedAssociation}}" class="certified-badge-yellow" bindtap="viewAssociationDetail">
                    {{shopInfo.certifiedAssociation.name}}
                  </view>
                </view>
                <view class="shop-rating-row">
                  <text class="rating-text">â­ {{shopInfo.rating}}</text>
                  <text class="rating-desc">è¯„åˆ†</text>
                  <text class="divider">Â·</text>
                  <text class="category-text">{{shopInfo.category}}</text>
                </view>
              </view>
            </view>
          </view>

          <view class="info-section">
            <view class="info-item" bindtap="openLocation">
              <image class="info-icon" src="{{iconLocation}}" mode="aspectFit"></image>
              <view class="info-content">
                <text class="info-label">åœ°å€</text>
                <text class="info-value">{{shopInfo.location}}</text>
              </view>
              <text class="nav-text">å¯¼èˆª</text>
            </view>
            <view class="info-item" bindtap="makeCall" data-phone="{{shopInfo.phone}}">
              <image class="info-icon" src="{{iconPhone}}" mode="aspectFit"></image>
              <view class="info-content">
                <text class="info-label">ç”µè¯</text>
                <text class="info-value link-text">{{shopInfo.phone}}</text>
              </view>
            </view>
            <view class="info-item" wx:if="{{shopInfo.businessHours}}">
              <image class="info-icon" src="{{iconTime}}" mode="aspectFit"></image>
              <view class="info-content">
                <text class="info-label">è¥ä¸šæ—¶é—´</text>
                <text class="info-value">{{shopInfo.businessHours}}</text>
              </view>
            </view>
          </view>
        </view>

        <!-- å•†å®¶è¯¦æƒ…ä¿¡æ¯ -->
        <view class="card merchant-info-card">
          <view class="section-title">å•†å®¶è¯¦æƒ…</view>
          
          <!-- åŸºæœ¬ä¿¡æ¯ -->
          <view class="merchant-basic-info">
            
            
            <view class="info-row">
              <view class="info-label">ç»è¥èŒƒå›´</view>
              <view class="info-value">{{shopInfo.merchantInfo.businessScope}}</view>
            </view>
            <view class="info-row">
              <view class="info-label">ç»è¥ç±»ç›®</view>
              <view class="info-value">{{shopInfo.merchantInfo.businessCategory}}</view>
            </view>
          </view>
          
          <!-- ä¼šå‘˜ä¿¡æ¯ -->
          <view class="merchant-member-info" wx:if="{{shopInfo.merchantInfo.memberTier}}">
            <view class="info-row">
              <view class="info-label">ä¼šå‘˜ç­‰çº§</view>
              <view class="info-value">
                <view class="member-tier-tag tier-{{shopInfo.merchantInfo.memberTier}}">
                  ç­‰çº§ {{shopInfo.merchantInfo.memberTier}}
                </view>
              </view>
            </view>
            <view class="info-row" wx:if="{{shopInfo.merchantInfo.tierExpireTime}}">
              <view class="info-label">ç­‰çº§åˆ°æœŸæ—¶é—´</view>
              <view class="info-value">{{shopInfo.merchantInfo.tierExpireTime}}</view>
            </view>
          </view>
          
          <!-- å®¡æ ¸ä¿¡æ¯ -->
          <view class="merchant-review-info">
            <view class="info-row">
              <view class="info-label">å®¡æ ¸çŠ¶æ€</view>
              <view class="info-value">
                <view class="review-status-tag status-{{shopInfo.merchantInfo.reviewStatus}}">
                  {{shopInfo.merchantInfo.reviewStatus === 0 ? 'å¾…å®¡æ ¸' : shopInfo.merchantInfo.reviewStatus === 1 ? 'å®¡æ ¸é€šè¿‡' : 'å®¡æ ¸å¤±è´¥'}}
                </view>
              </view>
            </view>
            <view class="info-row" wx:if="{{shopInfo.merchantInfo.reviewReason}}">
              <view class="info-label">å®¡æ ¸åŸå› </view>
              <view class="info-value">{{shopInfo.merchantInfo.reviewReason}}</view>
            </view>
            
          </view>
          
          <!-- çŠ¶æ€ä¿¡æ¯ -->
          <view class="merchant-status-info">
            <view class="info-row">
              <view class="info-label">å•†å®¶çŠ¶æ€</view>
              <view class="info-value">
                <view class="status-tag status-{{shopInfo.merchantInfo.status}}">
                  {{shopInfo.merchantInfo.status === 0 ? 'åœä¸š' : shopInfo.merchantInfo.status === 1 ? 'è¥ä¸šä¸­' : 'è£…ä¿®ä¸­'}}
                </view>
              </view>
            </view>
            <view class="info-row">
              <view class="info-label">æ ¡å‹è®¤è¯</view>
              <view class="info-value">
                <view class="certification-tag {{shopInfo.merchantInfo.isAlumniCertified ? 'certified' : 'not-certified'}}">
                  {{shopInfo.merchantInfo.isAlumniCertified ? 'å·²è®¤è¯' : 'æœªè®¤è¯'}}
                </view>
              </view>
            </view>
            
          </view>
        </view>

        <!-- é—¨åº—åˆ—è¡¨ -->
        <view class="card shops-list-card" wx:if="{{shopInfo.merchantInfo.shops && shopInfo.merchantInfo.shops.length}}">
          <view class="section-title-container">
            <view class="section-title">é—¨åº—åˆ—è¡¨</view>
            <view class="shop-count-tag">{{shopInfo.merchantInfo.shopCount || 0}}å®¶é—¨åº—</view>
          </view>
          <view class="shops-list">
            <view class="shop-item" wx:for="{{shopInfo.merchantInfo.shops}}" wx:key="shopId" bindtap="viewShopDetail" data-id="{{item.shopId}}">
              <view class="shop-item-header">
                <text class="shop-item-name">{{item.shopName}}</text>
              </view>
              <view class="shop-item-address">
                <image class="info-icon-small" src="{{iconLocation}}" mode="aspectFit"></image>
                <text>{{item.address || [item.province, item.city, item.district].filter(Boolean).join('')}}</text>
              </view>
            </view>
          </view>
        </view>

        <!-- åº—é“ºåŠ¨æ€/è¯é¢˜ -->
        <view class="card shop-dynamics" wx:if="{{shopInfo.dynamics && shopInfo.dynamics.length}}">
          <view class="section-title">åº—é“ºåŠ¨æ€</view>
          <view class="dynamics-list">
            <view class="dynamic-item" wx:for="{{shopInfo.dynamics}}" wx:key="id" bindtap="viewDynamicDetail" data-id="{{item.id}}">
              <image class="dynamic-image" src="{{item.image}}" mode="aspectFill" wx:if="{{item.image}}"></image>
              <view class="dynamic-content">
                <view class="dynamic-title">{{item.title}}</view>
                <view class="dynamic-desc">{{item.description}}</view>
                <view class="dynamic-meta">
                  <text class="dynamic-time">{{item.time}}</text>
                  <text class="dynamic-type">{{item.type === 'activity' ? 'æ´»åŠ¨' : 'æ–°å“'}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- æ ¡å‹è¶³è¿¹ -->
        <view class="card alumni-footprint" wx:if="{{shopInfo.recentAlumni && shopInfo.recentAlumni.length}}">
          <view class="section-title">æ ¡å‹è¶³è¿¹</view>
          <view class="footprint-desc">æœ€è¿‘æ¥è¿‡çš„æ ¡å‹</view>
          <view class="alumni-avatar-wall">
            <view 
              class="alumni-avatar-item" 
              wx:for="{{shopInfo.recentAlumni}}" 
              wx:key="id"
              bindtap="viewAlumniDetail"
              data-id="{{item.id}}"
              data-privacy="{{item.privacy}}"
            >
              <image 
                class="avatar-img {{item.privacy === 'private' ? 'blur' : ''}}" 
                src="{{item.privacy === 'private' ? defaultAvatar : item.avatar}}" 
                mode="aspectFill"
              ></image>
              <view class="avatar-info" wx:if="{{item.privacy === 'private'}}">
                <text class="privacy-text">{{item.school}}</text>
                <text class="privacy-text">{{item.grade}}çº§</text>
              </view>
              <view class="avatar-info" wx:else>
                <text class="name-text">{{item.name}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</custom-nav-bar>