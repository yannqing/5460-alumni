<!--pages/discover/discover.wxml-->
<!-- æ¶ˆæ¯é€šçŸ¥ç»„ä»¶ -->
<message-notification />

<view class="discover-page">
  <!-- è“è‰²å¤´éƒ¨ -->
  <view class="header-section">
    <view class="header-section-inner">
      <view class="header-top-row">
        <view class="logo-placeholder">logo</view>
      </view>
      <view class="search-container">
        <text class="search-icon">ğŸ”</text>
        <input
          class="search-input"
          placeholder="æœç´¢é™„è¿‘ä¼˜æƒ ã€åœºæ‰€ã€æ ¡å‹ã€æ´»åŠ¨"
          value="{{searchValue}}"
          confirm-type="search"
          bindinput="handleSearchInput"
          bindconfirm="handleSearchConfirm"
        />
        <view class="search-btn" bindtap="handleSearchConfirm">æœç´¢</view>
      </view>
    </view>
  </view>

  <!-- ç™½è‰²å†…å®¹åŒºåŸŸ -->
  <view class="white-content-container">
    <!-- å¯¼èˆªæ ‡ç­¾ -->
    <view class="nav-tabs">
      <view
        class="nav-tab {{selectedTab === item.id ? 'active' : ''}}"
        wx:for="{{navTabs}}"
        wx:key="id"
        data-id="{{item.id}}"
        bindtap="handleTabChange"
      >
        <text class="tab-icon">{{item.icon}}</text>
        <text class="tab-text">{{item.label}}</text>
      </view>
    </view>

  </view>

  <!-- è§†å›¾åˆ‡æ¢å’Œæ’åº -->
  <view class="view-sort-container">
    <view class="sort-options">
      <view
        class="sort-item {{sortType === item.id ? 'active' : ''}}"
        wx:for="{{sortOptions}}"
        wx:key="id"
        data-id="{{item.id}}"
        bindtap="handleSortChange"
      >
        {{item.label}}
      </view>
    </view>
    <view class="view-toggle">
      <view
        class="toggle-item {{viewMode === 'map' ? 'active' : ''}}"
        bindtap="switchViewMode"
        data-mode="map"
      >
        <text class="toggle-icon">ğŸ—ºï¸</text>
        <text class="toggle-text">åœ°å›¾</text>
      </view>
      <view
        class="toggle-item {{viewMode === 'list' ? 'active' : ''}}"
        bindtap="switchViewMode"
        data-mode="list"
      >
        <text class="toggle-icon">ğŸ“‹</text>
        <text class="toggle-text">åˆ—è¡¨</text>
      </view>
    </view>
  </view>

  <!-- åˆ—è¡¨è§†å›¾ -->
  <scroll-view
    class="list-view"
    wx:if="{{viewMode === 'list'}}"
    scroll-y="true"
    refresher-enabled="true"
    refresher-triggered="{{refreshing}}"
    bindrefresherrefresh="onPullDownRefresh"
    bindscrolltolower="onReachBottom"
    lower-threshold="100"
  >
    <!-- é™„è¿‘ä¼˜æƒ åˆ—è¡¨ -->
    <view class="content-list" wx:if="{{selectedTab === 'coupon'}}">
      <view class="empty-tip" wx:if="{{couponList.length === 0 && !loading}}">æš‚æ— é™„è¿‘ä¼˜æƒ </view>

      <view class="shop-card" wx:for="{{couponList}}" wx:key="id" bindtap="handleShopTap" data-id="{{item.id}}">
        <view class="shop-main">
          <image class="shop-image" src="{{item.image}}" mode="aspectFill"></image>
          <view class="shop-info">
            <text class="shop-name">{{item.name}}</text>
            <text class="shop-distance">{{item.distance}}</text>
            <view class="shop-tags" wx:if="{{item.associations && item.associations.length > 0}}">
              <text class="tag" wx:for="{{item.associations}}" wx:key="*this" wx:for-item="assoc">{{assoc}}</text>
            </view>
          </view>
        </view>

        <view class="coupons" wx:if="{{item.coupons && item.coupons.length > 0}}">
          <view class="coupon" wx:for="{{item.coupons}}" wx:key="*this" wx:for-item="coupon">
            <view class="coupon-left">
              <text class="coupon-value">{{coupon.discount}}</text>
              <text class="coupon-type">{{coupon.type}}</text>
            </view>
            <view class="coupon-right">
              <text class="coupon-title">{{coupon.title}}</text>
            </view>
          </view>
        </view>
      </view>

      <view class="no-more" wx:if="{{!hasMore && couponList.length > 0 && !loading}}">æ²¡æœ‰æ›´å¤šäº†</view>
    </view>

    <!-- é™„è¿‘åœºæ‰€åˆ—è¡¨ -->
    <view class="content-list" wx:if="{{selectedTab === 'venue'}}">
      <view class="empty-tip" wx:if="{{venueList.length === 0 && !loading}}">æš‚æ— é™„è¿‘åœºæ‰€</view>

      <view class="venue-card" wx:for="{{venueList}}" wx:key="id">
        <image class="venue-image" src="{{item.image}}" mode="aspectFill"></image>
        <view class="venue-content">
          <view class="venue-header">
            <view class="venue-name">{{item.name}}</view>
            <view class="venue-type-tag" wx:if="{{item.typeLabel}}">{{item.typeLabel}}</view>
          </view>

          <view class="venue-address" wx:if="{{item.address}}">
            <text class="venue-icon">ğŸ“</text>
            <text class="venue-address-text">{{item.address}}</text>
          </view>

          <view class="venue-info-row">
            <view class="venue-distance">
              <text class="venue-icon">ğŸ“</text>
              <text>{{item.distance}}</text>
            </view>
            <view class="venue-contact" wx:if="{{item.contactPhone}}">
              <text class="venue-icon">ğŸ“</text>
              <text>{{item.contactPhone}}</text>
            </view>
          </view>

          <view class="venue-stats" wx:if="{{item.ratingScore > 0 || item.viewCount > 0}}">
            <view class="stat-item" wx:if="{{item.ratingScore > 0}}">
              <text class="stat-icon">â­</text>
              <text class="stat-text">{{item.ratingScore}}åˆ†</text>
            </view>
            <view class="stat-item" wx:if="{{item.viewCount > 0}}">
              <text class="stat-icon">ğŸ‘ï¸</text>
              <text class="stat-text">{{item.viewCount}}æ¬¡æµè§ˆ</text>
            </view>
          </view>

          <view class="venue-description" wx:if="{{item.description}}">{{item.description}}</view>
        </view>
      </view>

      <view class="no-more" wx:if="{{!hasMore && venueList.length > 0 && !loading}}">æ²¡æœ‰æ›´å¤šäº†</view>
    </view>

    <!-- é™„è¿‘æ ¡å‹åˆ—è¡¨ -->
    <view class="content-list" wx:if="{{selectedTab === 'alumni'}}">
      <view class="content-card" wx:for="{{alumniList}}" wx:key="id">
        <view class="card-avatar">
          <image class="avatar-img" src="{{item.avatar}}" mode="aspectFill" wx:if="{{item.avatar}}"></image>
        </view>
        <view class="card-content">
          <view class="card-name">{{item.name}}</view>
          <view class="card-distance">è·ç¦» {{item.distance}}</view>
          <view class="card-signature" wx:if="{{item.signature}}">{{item.signature}}</view>
          <view class="card-association" wx:if="{{item.association}}">{{item.association}}</view>
          <view class="card-tag" wx:if="{{item.tag}}">{{item.tag}}</view>
        </view>
        <view class="card-action">
          <view class="follow-btn {{item.isFollowed ? 'followed' : ''}}" bindtap="handleFollow" data-id="{{item.id}}" data-followed="{{item.isFollowed}}">
            {{item.isFollowed ? 'å·²å…³æ³¨' : 'å…³æ³¨'}}
          </view>
        </view>
      </view>
    </view>

    <!-- é™„è¿‘æ´»åŠ¨åˆ—è¡¨ -->
    <view class="content-list" wx:if="{{selectedTab === 'activity'}}">
      <view class="activity-card" wx:for="{{activityList}}" wx:key="id">
        <view class="activity-title">{{item.title}}</view>
        <view class="activity-date">{{item.dateRange}}</view>
        <view class="activity-association">{{item.association}}</view>
        <view class="activity-participants">
          <view class="participant-avatars">
            <view class="participant-avatar" wx:for="{{item.participantAvatars}}" wx:key="*this" wx:for-item="avatar" wx:for-index="idx">
              <image class="avatar-small" src="{{avatar}}" mode="aspectFill" wx:if="{{avatar}}"></image>
            </view>
          </view>
          <text class="participant-text">ç­‰{{item.participantCount}}ä½æ ¡å‹å·²ç»å‚ä¸</text>
        </view>
        <view class="activity-actions">
          <view class="signup-btn" bindtap="handleSignup" data-id="{{item.id}}">æˆ‘è¦æŠ¥å</view>
        </view>
        <view class="activity-footer">
          <text class="activity-location">{{item.location}}</text>
          <view class="activity-icons">
            <view class="icon-item" bindtap="handleLike" data-id="{{item.id}}">
              <text class="icon-like">ğŸ‘</text>
            </view>
            <view class="icon-item" bindtap="handleShare" data-id="{{item.id}}">
              <text class="icon-share">ğŸ“¤</text>
            </view>
          </view>
        </view>
        <view class="activity-status" wx:if="{{item.signedUp}}">
          <view class="signed-btn">å·²æŠ¥å</view>
          <text class="signed-count">{{item.signedCount}}</text>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- åœ°å›¾è§†å›¾ -->
  <view class="map-view" wx:if="{{viewMode === 'map'}}">
    <map
      id="discoverMap"
      class="discover-map"
      latitude="{{mapCenter.latitude}}"
      longitude="{{mapCenter.longitude}}"
      scale="{{mapScale}}"
      markers="{{mapMarkers}}"
      bindmarkertap="onMarkerTap"
      bindtap="onMapTap"
    ></map>
    <!-- éšè—çš„ Canvasï¼Œç”¨äºç»˜åˆ¶åœ†å½¢å¤´åƒ -->
    <canvas canvas-id="roundAvatarCanvas" class="hidden-canvas"></canvas>
    <!-- å®šä½åˆ°æˆ‘çš„ä½ç½®æŒ‰é’® -->
    <view class="location-btn" bindtap="locateToMyPosition">
      <text class="location-icon">ğŸ“</text>
    </view>
  </view>
</view>
