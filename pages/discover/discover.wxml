<!--pages/discover/discover.wxml-->
<view class="discover-page">
  <!-- é¡¶éƒ¨æœç´¢æ  -->
  <view class="hero-card">
    <view class="search-bar">
      <image class="search-icon-img" src="{{iconSearch}}" mode="aspectFit"></image>
      <input
        class="search-input"
        placeholder="æœç´¢å•†å®¶ / ä¼˜æƒ åˆ¸ / æ´»åŠ¨"
        value="{{searchValue}}"
        confirm-type="search"
        bindinput="handleSearchInput"
        bindconfirm="handleSearchConfirm"
      />
      <view class="scan-btn" bindtap="scanCode">
        <image class="scan-icon" src="{{iconScan}}" mode="aspectFit"></image>
      </view>
      <view class="search-action" bindtap="handleSearchConfirm">æœç´¢</view>
    </view>

    <view class="hero-stats">
      <view class="stats-item">
        <text class="stats-value">{{stats.merchantCount}}</text>
        <text class="stats-label">åˆä½œå•†å®¶</text>
      </view>
      <view class="stats-item">
        <text class="stats-value">{{stats.couponCount}}</text>
        <text class="stats-label">å¯ç”¨ä¼˜æƒ åˆ¸</text>
      </view>
      <view class="stats-item">
        <text class="stats-value">{{stats.activityCount}}</text>
        <text class="stats-label">è¿›è¡Œä¸­æ´»åŠ¨</text>
      </view>
    </view>
  </view>

  <!-- æ¨¡å¼åˆ‡æ¢ -->
  <view class="mode-switch-bar">
    <view class="mode-switch">
      <view class="mode-item {{viewMode === 'list' ? 'active' : ''}}" bindtap="switchViewMode" data-mode="list">
        <text class="mode-icon">ğŸ“‹</text>
        <text class="mode-text">åˆ—è¡¨</text>
      </view>
      <view class="mode-item {{viewMode === 'map' ? 'active' : ''}}" bindtap="switchViewMode" data-mode="map">
        <text class="mode-icon">ğŸ—ºï¸</text>
        <text class="mode-text">åœ°å›¾</text>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰æ  -->
  <view class="filter-bar">
    <!-- åˆ†ç±»ç­›é€‰ -->
    <scroll-view class="category-bar" scroll-x enable-flex>
    <view
      class="category-chip {{selectedCategory === item.id ? 'active' : ''}}"
      wx:for="{{categories}}"
      wx:key="id"
      data-id="{{item.id}}"
      bindtap="handleCategoryChange"
    >
      {{item.label}}
    </view>
    </scroll-view>

    <!-- æ ¡å‹å•†é“ºå¼€å…³ -->
    <view class="alumni-shop-filter">
      <view class="filter-label">
        <text class="filter-icon">ğŸª</text>
        <text class="filter-text">æ ¡å‹å•†é“º</text>
      </view>
      <switch checked="{{showAlumniOnly}}" bindchange="toggleAlumniOnly" color="#ff6b9d" />
    </view>
  </view>

  <!-- æ’åºé€‰é¡¹ -->
  <view class="sort-row">
    <view
      class="sort-option {{sortType === option.id ? 'active' : ''}}"
      wx:for="{{sortOptions}}"
      wx:key="id"
      wx:for-item="option"
      data-id="{{option.id}}"
      bindtap="handleSortChange"
    >
      {{option.label}}
    </view>
    <view class="sort-extra" bindtap="getLocation">é‡æ–°å®šä½</view>
  </view>

  <!-- åœ°å›¾æ¨¡å¼ -->
  <view class="map-container" wx:if="{{viewMode === 'map'}}">
    <map
      id="discoverMap"
      class="discover-map"
      latitude="{{mapCenter.latitude}}"
      longitude="{{mapCenter.longitude}}"
      scale="{{mapScale}}"
      markers="{{mapMarkers}}"
      bindmarkertap="onMarkerTap"
      bindtap="onMapTap"
    ></map>
    <!-- åº•éƒ¨æŠ½å±‰ -->
    <view class="map-drawer {{showDrawer ? 'show' : ''}}" catchtap="true">
      <view class="drawer-handle" bindtap="toggleDrawer"></view>
      <view class="drawer-content" wx:if="{{selectedMerchant}}">
        <view class="drawer-header">
          <image class="drawer-avatar" src="{{selectedMerchant.avatar}}" mode="aspectFill"></image>
          <view class="drawer-info">
            <view class="drawer-name-row">
              <text class="drawer-name">{{selectedMerchant.name}}</text>
              <view wx:if="{{selectedMerchant.isCertified}}" class="drawer-cert-badge">æ ¡å‹å•†é“º</view>
            </view>
            <view class="drawer-meta">
              <text>â­ {{selectedMerchant.rating}}</text>
              <text class="meta-divider">Â·</text>
              <text>è·ç¦» {{selectedMerchant.distance}}m</text>
            </view>
          </view>
        </view>
        <view class="drawer-coupons" wx:if="{{selectedMerchant.coupons && selectedMerchant.coupons.length}}">
          <scroll-view class="drawer-coupons-scroll" scroll-x>
            <view class="drawer-coupon-item" wx:for="{{selectedMerchant.coupons}}" wx:key="id" bindtap="viewCouponDetail" data-id="{{item.id}}" catchtap="true">
              <text class="drawer-coupon-discount">{{item.discount}}</text>
              <text class="drawer-coupon-title">{{item.title}}</text>
            </view>
          </scroll-view>
        </view>
        <view class="drawer-action" bindtap="viewMerchantDetail" data-id="{{selectedMerchant.id}}" catchtap="true">
          <text>æŸ¥çœ‹è¯¦æƒ… â€º</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å•†å®¶åˆ—è¡¨ -->
  <view class="merchant-list" wx:if="{{viewMode === 'list'}}">
    <block wx:if="{{loading}}">
      <view class="skeleton-card" wx:for="{{[1,2,3]}}" wx:key="*this">
        <view class="skeleton-line wide"></view>
        <view class="skeleton-line"></view>
        <view class="skeleton-tags">
          <view class="skeleton-tag"></view>
          <view class="skeleton-tag"></view>
        </view>
      </view>
    </block>

    <block wx:elif="{{displayList.length}}">
      <view class="merchant-card" wx:for="{{displayList}}" wx:key="id" bindtap="viewMerchantCoupons" data-id="{{item.id}}">
        <view class="merchant-header">
          <view class="merchant-avatar-wrapper">
            <image class="merchant-avatar" src="{{item.avatar}}" mode="aspectFill" bindtap="viewMerchantDetail" data-id="{{item.id}}" catchtap="true"></image>
            <view wx:if="{{item.isCertified}}" class="alumni-shop-badge">æ ¡å‹å•†é“º</view>
          </view>
          <view class="merchant-info">
            <view class="merchant-name-row">
              <text class="merchant-name">{{item.name}}</text>
            </view>
            <view class="merchant-meta">
              <text class="merchant-rating">â­ {{item.rating}}</text>
              <text class="meta-divider">Â·</text>
              <text class="merchant-avg-price" wx:if="{{item.avgPrice}}">äººå‡Â¥{{item.avgPrice}}</text>
              <text class="meta-divider" wx:if="{{item.avgPrice}}">Â·</text>
              <text class="merchant-distance">è·ç¦» {{item.distance}}m</text>
            </view>
            <!-- ç¤¾äº¤è¯æ˜ -->
            <view class="social-proof" wx:if="{{item.socialProof}}">
              <text class="proof-text" wx:if="{{item.socialProof.association}}">{{item.socialProof.association}}æˆå‘˜å¸¸å»</text>
              <text class="proof-text" wx:if="{{item.socialProof.recentAlumni}}">{{item.socialProof.recentAlumni}}ä½æ ¡å‹åˆšåˆšæ¥è¿‡</text>
            </view>
          </view>
        </view>
        <scroll-view class="merchant-coupons" scroll-x>
          <view class="coupon-item" wx:for="{{item.coupons}}" wx:key="id" wx:for-item="coupon" bindtap="handleCouponClick" data-coupon="{{coupon}}" data-merchant="{{item}}" catchtap="true">
            <view class="coupon-card-mini">
              <view class="coupon-left">
                <view class="coupon-discount-large">{{coupon.discount}}</view>
                <view class="coupon-label">ä¼˜æƒ åˆ¸</view>
              </view>
              <view class="coupon-divider"></view>
              <view class="coupon-right">
                <view class="coupon-title-mini">{{coupon.title}}</view>
                <view class="coupon-expire-mini">æœ‰æ•ˆæœŸè‡³ {{coupon.expireDate}}</view>
              </view>
            </view>
          </view>
        </scroll-view>
      </view>
    </block>

    <view class="empty-state" wx:else>
      <image class="empty-img" src="https://cdn.example.com/empty-benefit.png" mode="widthFix"></image>
      <text class="empty-text">æš‚æ— ç¬¦åˆæ¡ä»¶çš„å•†å®¶</text>
      <view class="empty-btn" bindtap="refreshPage">é‡ç½®ç­›é€‰</view>
    </view>
  </view>
</view>
