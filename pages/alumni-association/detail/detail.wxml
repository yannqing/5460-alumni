<!--pages/alumni-association/detail/detail.wxml-->
<!-- æ¶ˆæ¯é€šçŸ¥ç»„ä»¶ -->
<message-notification />

<view class="container">
  <view wx:if="{{associationInfo}}">
    <image class="cover-image" src="{{associationInfo.cover}}" mode="aspectFill" />

    <view class="card">
      <view class="flex">
        <image class="avatar avatar-large" src="{{associationInfo.icon}}" mode="aspectFill" />
        <view class="flex-1 ml-20">
          <view class="name-row">
            <text class="text-primary text-bold">{{associationInfo.name}}</text>
            <view wx:if="{{associationInfo.certifications && associationInfo.certifications.length}}" class="cert-tag-wrap">
              <block wx:for="{{associationInfo.certifications}}" wx:key="id">
                <view class="cert-tag" data-type="{{item.type}}" data-id="{{item.id}}" catchtap="handleCertificationTap">
                  {{item.label}}
                </view>
              </block>
            </view>
          </view>
          <view wx:if="{{associationInfo.schoolName}}" class="text-secondary mt-10 school-row" catchtap="viewSchoolDetail">
            <image class="school-icon" src="/assets/icons/å­¦æ ¡.png" mode="aspectFit" />
            <view class="school-tag">{{associationInfo.schoolName}}</view>
          </view>
          <view wx:if="{{associationInfo.location}}" class="text-placeholder mt-10 location-row">
            <image class="location-icon" src="/assets/icons/å®šä½.png" mode="aspectFit" />
            <text>{{associationInfo.location}}</text>
          </view>
        </view>
      </view>
      <view class="mt-20">
        <view class="join-button {{associationInfo.applicationStatus === 0 ? 'pending' : ''}} {{associationInfo.applicationStatus === 1 ? 'joined' : ''}} {{associationInfo.applicationStatus === 2 ? 'rejected' : ''}}" bindtap="toggleJoin">
          <block wx:if="{{associationInfo.applicationStatus === 0}}">å®¡æ ¸ä¸­</block>
          <block wx:elif="{{associationInfo.applicationStatus === 1}}">å·²åŠ å…¥æ ¡å‹ä¼š</block>
          <block wx:elif="{{associationInfo.applicationStatus === 2}}">ç”³è¯·è¢«æ‹’ç»</block>
          <block wx:else>åŠ å…¥æ ¡å‹ä¼š</block>
        </view>
      </view>
    </view>

    <view class="tabs">
      <view class="tab-item {{activeTab === index ? 'active' : ''}}" wx:for="{{tabs}}" wx:key="*this" bindtap="switchTab" data-index="{{index}}">
        {{item}}
      </view>
    </view>

    <view wx:if="{{activeTab === 0}}" class="tab-content">
      <view class="card">
        <view class="text-bold mb-20">åŸºæœ¬ä¿¡æ¯</view>
        <view wx:if="{{associationInfo.description}}" class="text-secondary">{{associationInfo.description}}</view>
        <view class="divider"></view>
        <view wx:if="{{associationInfo.president}}" class="text-secondary">ä¼šé•¿ï¼š{{associationInfo.president}}</view>
        <view class="text-secondary mt-10">æˆå‘˜ï¼š{{associationInfo.memberCount || 0}}äºº</view>
        <view wx:if="{{associationInfo.establishedYear}}" class="text-secondary mt-10">æˆç«‹äºï¼š{{associationInfo.establishedYear}}å¹´</view>
        <view wx:if="{{associationInfo.contactInfo}}" class="text-secondary mt-10">è”ç³»ä¿¡æ¯ï¼š{{associationInfo.contactInfo}}</view>
      </view>

      <!-- é€šçŸ¥åˆ—è¡¨ -->
      <view class="card mt-20 dashboard-card">
        <view class="section-header">
          <view class="section-title">
            <view class="text-bold">é€šçŸ¥</view>
            <view class="section-subtitle">æœ€æ–°æé†’ã€é‡è¦åŠ¨æ€</view>
          </view>
          <view class="text-placeholder" bindtap="viewNotificationDetail" data-id="all">æŸ¥çœ‹æ›´å¤š</view>
        </view>
        <view class="dashboard-list notification" wx:for="{{notifications}}" wx:key="id" bindtap="viewNotificationDetail" data-id="{{item.id}}">
          <view class="dashboard-item">
            <view class="item-leading">
              <view class="item-icon notify-icon">é€š</view>
            </view>
            <view class="item-content">
              <view class="item-title">{{item.title}}</view>
              <view class="item-desc">{{item.content}}</view>
              <view class="item-meta">
                <text>{{item.time}}</text>
                <view wx:if="{{!item.isRead}}" class="status-dot"></view>
              </view>
            </view>
            <view class="item-extra">
              <text class="chevron">â€º</text>
            </view>
          </view>
        </view>
      </view>

      <!-- æ´»åŠ¨åˆ—è¡¨ -->
      <view class="card mt-20 dashboard-card">
        <view class="section-header">
          <view class="section-title">
            <view class="text-bold">æ´»åŠ¨</view>
            <view class="section-subtitle">è¿‘æœŸçƒ­ç‚¹æ ¡å‹æ´»åŠ¨</view>
          </view>
          <view class="text-placeholder" bindtap="viewActivityDetail" data-id="all">æŸ¥çœ‹æ›´å¤š</view>
        </view>
        <view class="dashboard-list activity" wx:for="{{benefitActivities}}" wx:key="id" bindtap="viewActivityDetail" data-id="{{item.id}}">
          <view class="dashboard-item">
            <view class="item-leading">
              <view class="item-icon activity-icon">æ´»</view>
            </view>
            <view class="item-content">
              <view class="item-title">{{item.title}}</view>
              <view class="item-desc location-row">
                <image class="location-icon" src="/assets/icons/å®šä½.png" mode="aspectFit" />
                <text>{{item.location}}</text>
              </view>
              <view class="item-meta">
                <text>ğŸ• {{item.time}}</text>
                <text class="meta-divider">Â·</text>
                <text>{{item.participantCount}}äººæŠ¥å</text>
              </view>
            </view>
            <view class="item-extra">
              <view class="item-chip">æŠ¥åä¸­</view>
              <text class="chevron">â€º</text>
            </view>
          </view>
        </view>
      </view>

      <!-- é™„è¿‘æƒç›Šåˆ—è¡¨ -->
      <view class="card mt-20 dashboard-card">
        <view class="section-header">
          <view class="section-title">
            <view class="text-bold">é™„è¿‘æƒç›Š</view>
            <view class="section-subtitle">ä¼˜é€‰å•†æˆ·æƒç›Šéšæ—¶ç”¨</view>
          </view>
          <view class="text-placeholder" bindtap="viewBenefitDetail" data-id="all">æŸ¥çœ‹æ›´å¤š</view>
        </view>
        <view class="dashboard-list benefit" wx:for="{{nearbyBenefits}}" wx:key="id" bindtap="viewBenefitDetail" data-id="{{item.id}}">
          <view class="dashboard-item">
            <view class="item-leading benefit-leading">
              <view class="benefit-tag">{{item.discount}}</view>
            </view>
            <view class="item-content">
              <view class="item-title">
                {{item.title}}
                <view wx:if="{{item.isNew}}" class="new-badge-inline">ä¸Šæ–°</view>
              </view>
              <view class="item-desc">{{item.merchant}}</view>
              <view class="item-meta">
                <text>è·ç¦»{{item.distance}}</text>
              </view>
            </view>
            <view class="item-extra">
              <view class="item-chip ghost">æŸ¥çœ‹</view>
              <text class="chevron">â€º</text>
            </view>
          </view>
        </view>
      </view>

      <!-- æ ¡å‹ä¼ä¸šåˆ—è¡¨ -->
      <view class="card mt-20 dashboard-card">
        <view class="section-header">
          <view class="section-title">
            <view class="text-bold">æ ¡å‹ä¼ä¸š</view>
            <view class="section-subtitle">ä¼˜ç§€æ ¡å‹åˆ›åŠçš„ä¼ä¸š</view>
          </view>
          <view class="text-placeholder" bindtap="viewEnterpriseDetail" data-id="all">æŸ¥çœ‹æ›´å¤š</view>
        </view>
        <view class="dashboard-list enterprise" wx:for="{{alumniEnterprises}}" wx:key="id" bindtap="viewEnterpriseDetail" data-id="{{item.id}}">
          <view class="dashboard-item">
            <view class="item-leading">
              <view class="item-icon enterprise-icon">ä¼</view>
            </view>
            <view class="item-content">
              <view class="item-title">{{item.name}}</view>
              <view class="item-desc">{{item.description}}</view>
              <view class="item-meta">
                <text>{{item.industry}}</text>
                <text class="meta-divider">Â·</text>
                <text>{{item.location}}</text>
              </view>
            </view>
            <view class="item-extra">
              <text class="chevron">â€º</text>
            </view>
          </view>
        </view>
      </view>

      <!-- æ ¡å‹å•†é“ºåˆ—è¡¨ -->
      <view class="card mt-20 dashboard-card">
        <view class="section-header">
          <view class="section-title">
            <view class="text-bold">æ ¡å‹å•†é“º</view>
            <view class="section-subtitle">æ ¡å‹ç»è¥çš„ä¼˜è´¨å•†é“º</view>
          </view>
          <view class="text-placeholder" bindtap="viewShopDetail" data-id="all">æŸ¥çœ‹æ›´å¤š</view>
        </view>
        <view class="dashboard-list shop" wx:for="{{alumniShops}}" wx:key="id" bindtap="viewShopDetail" data-id="{{item.id}}">
          <view class="dashboard-item">
            <view class="item-leading">
              <view class="item-icon shop-icon">å•†</view>
            </view>
            <view class="item-content">
              <view class="item-title">{{item.name}}</view>
              <view class="item-desc">{{item.description}}</view>
              <view class="item-meta">
                <text class="rating-text">â­ {{item.rating}}</text>
                <text class="meta-divider">Â·</text>
                <text>{{item.category}}</text>
                <text class="meta-divider">Â·</text>
                <text>è·ç¦»{{item.distance}}</text>
              </view>
            </view>
            <view class="item-extra">
              <text class="chevron">â€º</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <view wx:if="{{activeTab === 1}}">
      <view class="member-list">
        <!-- éª¨æ¶å± -->
        <view wx:if="{{loading && members.length === 0}}" class="skeleton-list">
          <view class="member-item skeleton-item" wx:for="[1,2,3,4,5]" wx:key="*this">
            <view class="member-avatar skeleton-avatar"></view>
            <view class="member-info">
              <view class="member-name-row">
                <view class="skeleton-name"></view>
                <view class="skeleton-tag"></view>
              </view>
              <view class="skeleton-text"></view>
            </view>
          </view>
        </view>
        
        <!-- æˆå‘˜åˆ—è¡¨ -->
        <view wx:elif="{{members.length > 0}}">
          <view class="member-item" wx:for="{{members}}" wx:key="id" bindtap="viewMemberDetail" data-id="{{item.id}}">
            <image class="member-avatar" src="{{item.avatar}}" mode="aspectFill" />
            <view class="member-info">
              <view class="member-name-row">
                <text class="member-name">{{item.name}}</text>
                <view class="member-tag">{{item.role}}</view>
              </view>
              <view class="member-company">{{item.company}}</view>
            </view>
          </view>
        </view>
        
        <!-- ç©ºçŠ¶æ€ -->
        <view wx:else class="empty-container">
          <view class="empty-icon">ğŸ‘¥</view>
          <view class="empty-text">æš‚æ— æˆå‘˜æ•°æ®</view>
          <view class="empty-desc">è¯¥æ ¡å‹ä¼šè¿˜æ²¡æœ‰æˆå‘˜ï¼Œå¿«æ¥åŠ å…¥å§</view>
        </view>
      </view>
    </view>

    <!-- ç»„ç»‡ç»“æ„æ ‡ç­¾é¡µ -->
    <view wx:if="{{activeTab === 2}}" class="tab-content">
      <view class="card dashboard-card">
        <view class="section-header">
          <view class="section-title">
            <view class="text-bold">ç»„ç»‡ç»“æ„</view>
            <view class="section-subtitle">ç»„ç»‡æ¶æ„å±•ç¤º</view>
          </view>
        </view>
        
        <view class="role-list-section">
          <!-- éª¨æ¶å± -->
          <view wx:if="{{organizationLoading}}" class="skeleton-role-list">
            <view class="role-item skeleton-item" wx:for="[1,2,3]" wx:key="*this">
              <view class="role-header">
                <view class="role-name-container">
                  <text class="expand-icon">â–¶</text>
                  <view class="skeleton-role-name"></view>
                </view>
                <view class="skeleton-role-count"></view>
              </view>
            </view>
          </view>
          
          <!-- ç©ºçŠ¶æ€ -->
          <view wx:elif="{{roleList.length === 0}}" class="empty-container">
            <text class="empty-text">æš‚æ— è§’è‰²æ•°æ®</text>
          </view>
          
          <view wx:else class="org-tree">
            <!-- ä¸€çº§èŠ‚ç‚¹ -->
            <view wx:for="{{roleList}}" wx:key="uniqueId" wx:for-item="node1" class="tree-node level-1">
              <view class="node-header" bindtap="toggleExpand" data-id="{{node1.uniqueId}}">
                <view class="node-title">
                  <text class="expand-icon {{node1.expanded ? 'expanded' : ''}}">â–¶</text>
                  <text class="role-name">{{node1.roleOrName}}</text>
                </view>
                <view class="node-meta">
                  <text class="member-count">{{node1.members.length}}äºº</text>
                </view>
              </view>

              <view class="node-content" wx:if="{{node1.expanded}}">
                <!-- ä¸€çº§èŠ‚ç‚¹æˆå‘˜ -->
                <view class="node-members" wx:if="{{node1.members.length > 0}}">
                  <view class="org-member-grid">
                    <view class="org-member-item" wx:for="{{node1.members}}" wx:key="wxId" wx:for-item="member">
                      <image class="org-member-avatar" src="{{member.avatarUrl}}" mode="aspectFill"></image>
                      <view class="org-member-info">
                        <text class="org-member-name">{{member.name || member.nickname}}</text>
                        <text class="org-member-role">{{node1.roleOrName}}</text>
                      </view>
                    </view>
                  </view>
                </view>

                <!-- äºŒçº§èŠ‚ç‚¹ -->
                <view class="children-nodes" wx:if="{{node1.children && node1.children.length > 0}}">
                  <view wx:for="{{node1.children}}" wx:key="uniqueId" wx:for-item="node2" class="tree-node level-2">
                    <view class="node-header" bindtap="toggleExpand" data-id="{{node2.uniqueId}}">
                      <view class="node-title">
                        <text class="expand-icon {{node2.expanded ? 'expanded' : ''}}">â–¶</text>
                        <text class="role-name">{{node2.roleOrName}}</text>
                      </view>
                      <view class="node-meta">
                        <text class="member-count">{{node2.members.length}}äºº</text>
                      </view>
                    </view>

                    <view class="node-content" wx:if="{{node2.expanded}}">
                      <!-- äºŒçº§èŠ‚ç‚¹æˆå‘˜ -->
                       <view class="node-members" wx:if="{{node2.members.length > 0}}">
                        <view class="org-member-grid">
                          <view class="org-member-item" wx:for="{{node2.members}}" wx:key="wxId" wx:for-item="member">
                            <image class="org-member-avatar" src="{{member.avatarUrl}}" mode="aspectFill"></image>
                            <view class="org-member-info">
                              <text class="org-member-name">{{member.name || member.nickname}}</text>
                              <text class="org-member-role">{{node2.roleOrName}}</text>
                            </view>
                          </view>
                        </view>
                      </view>

                      <!-- ä¸‰çº§èŠ‚ç‚¹ -->
                      <view class="children-nodes" wx:if="{{node2.children && node2.children.length > 0}}">
                        <view wx:for="{{node2.children}}" wx:key="uniqueId" wx:for-item="node3" class="tree-node level-3">
                          <view class="node-header" bindtap="toggleExpand" data-id="{{node3.uniqueId}}">
                            <view class="node-title">
                              <text class="expand-icon {{node3.expanded ? 'expanded' : ''}}">â–¶</text>
                              <text class="role-name">{{node3.roleOrName}}</text>
                            </view>
                            <view class="node-meta">
                              <text class="member-count">{{node3.members.length}}äºº</text>
                            </view>
                          </view>

                          <view class="node-content" wx:if="{{node3.expanded}}">
                            <!-- ä¸‰çº§èŠ‚ç‚¹æˆå‘˜ -->
                             <view class="node-members" wx:if="{{node3.members.length > 0}}">
                              <view class="org-member-grid">
                                <view class="org-member-item" wx:for="{{node3.members}}" wx:key="wxId" wx:for-item="member">
                                  <image class="org-member-avatar" src="{{member.avatarUrl}}" mode="aspectFill"></image>
                                  <view class="org-member-info">
                                    <text class="org-member-name">{{member.name || member.nickname}}</text>
                                    <text class="org-member-role">{{node3.roleOrName}}</text>
                                  </view>
                                </view>
                              </view>
                            </view>
                          </view>
                        </view>
                      </view>
                    </view>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

  </view>
</view>
