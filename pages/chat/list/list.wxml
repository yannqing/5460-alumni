<!--pages/chat/list/list.wxml-->
<!-- 消息通知组件 -->
<message-notification />

<view class="page">
  <!-- 顶部自定义导航栏区域 (Fixed) -->
  <view class="header-section" style="background-image: url({{imageTopBg}}); padding-top: {{statusBarHeight}}px;">
    <!-- 标题栏 -->
    <view class="page-title">
      <text class="title-text">5460</text>
    </view>

    <!-- 顶部功能入口 (我的校友会、我的收藏、我的关注) -->
    <view class="top-functions">
      <view class="function-item" bindtap="navigateToMyAssociations">
        <image class="function-icon" src="{{iconAlumni}}" mode="aspectFit"></image>
        <text class="function-text">我的校友会</text>
      </view>
      <view class="function-item">
        <image class="function-icon" src="{{iconFav}}" mode="aspectFit"></image>
        <text class="function-text">我的收藏</text>
        <view class="construction-tag">建设中</view>
      </view>
      <view class="function-item" bindtap="navigateToMyFollows">
        <image class="function-icon" src="{{iconFollow}}" mode="aspectFit"></image>
        <text class="function-text">我的关注</text>
      </view>
    </view>
  </view>

  <!-- Banner 横幅 (固定在顶部) -->
  <view class="banner-wrapper">
    <image class="banner-image" src="{{imageBanner}}" mode="widthFix"></image>
  </view>

  <!-- 滚动内容区域 -->
  <scroll-view class="content-scroll" scroll-y show-scrollbar="{{false}}" refresher-enabled="{{false}}" enable-back-to-top="{{false}}">
    
    <!-- 聊天列表 -->
    <view class="chat-list-container">
      <block wx:for="{{allChatList}}" wx:key="id">
        <view class="chat-item {{item.isTouchMove ? 'touch-move-active' : ''}}" 
              bindtouchstart="touchstart" 
              bindtouchmove="touchmove" 
              data-index="{{index}}"
              bindtap="openChat" 
              data-id="{{item.id}}" 
              data-peerid="{{item.peerId}}" 
              data-type="{{item.type || 'chat'}}">
          
          <view class="chat-content">
            <!-- 头像 -->
            <view class="chat-avatar-wrapper">
              <image class="chat-avatar {{item.isSystemNotification ? 'system-avatar' : ''}}" src="{{item.avatar}}" mode="aspectFill"></image>
              <view class="unread-badge" wx:if="{{item.unreadCount > 0}}">{{item.unreadCount > 99 ? '99+' : item.unreadCount}}</view>
            </view>

            <!-- 文本信息 -->
            <view class="chat-info">
              <view class="chat-header">
                <text class="chat-name">{{item.name}}</text>
                <text class="chat-time">{{item.lastTime}}</text>
              </view>
              <view class="chat-message-row">
                <text class="chat-message">{{item.lastMessage}}</text>
              </view>
            </view>
          </view>

          <!-- 滑动操作按钮 -->
          <view class="action-buttons">
            <view class="action-btn pin {{item.isPinned ? 'unpin' : ''}}" catchtap="pinConversation" data-index="{{index}}" data-id="{{item.conversationId}}" data-ispinned="{{item.isPinned}}">
              {{item.isPinned ? '取消' : '置顶'}}
            </view>
            <view class="action-btn read {{item.unreadCount > 0 ? 'has-unread' : 'no-unread'}}" catchtap="markRead" data-index="{{index}}" data-peerid="{{item.peerId}}" data-conversationid="{{item.conversationId}}" data-unreadcount="{{item.unreadCount}}">
              {{item.unreadCount > 0 ? '已读' : '未读'}}
            </view>
            <view class="action-btn delete" catchtap="deleteConversation" data-index="{{index}}" data-id="{{item.conversationId}}">
              删除
            </view>
          </view>
        </view>
        <!-- 分割线 -->
        <view class="list-divider"></view>
      </block>

      <!-- 空状态 -->
      <view class="empty-state" wx:if="{{allChatList.length === 0 && !loading}}">
        <text class="empty-text">暂无聊天记录</text>
      </view>
    </view>
    
    <!-- 底部垫高，防止被 TabBar 遮挡 -->
    <view style="height: 120rpx;"></view>
  </scroll-view>
</view>