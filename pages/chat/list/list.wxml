<!--pages/chat/list/list.wxml-->
<!-- æ¶ˆæ¯é€šçŸ¥ç»„ä»¶ -->
<message-notification />

<view class="chat-page">
  <!-- èœå•æ  -->
  <view class="menu-bar">
    <view class="menu-btn" bindtap="toggleSidebar">
      <text class="menu-icon">â˜°</text>
      <text class="menu-text">èœå•</text>
    </view>
  </view>

  <!-- ä¾§è¾¹æ é®ç½© -->
  <view class="sidebar-mask {{showSidebar ? 'show' : ''}}" bindtap="toggleSidebar"></view>

  <!-- ä¾§è¾¹æ  -->
  <view class="sidebar {{showSidebar ? 'show' : ''}}">
    <view class="sidebar-header">
      <text class="sidebar-title">èœå•</text>
      <text class="sidebar-close" bindtap="toggleSidebar">Ã—</text>
    </view>
    <view class="sidebar-content">
      <view class="sidebar-item" bindtap="navigateToMyAssociations">
        <text class="sidebar-icon">ğŸ‘¥</text>
        <text class="sidebar-text">æˆ‘åŠ å…¥çš„æ ¡å‹ä¼š</text>
        <text class="sidebar-arrow">â€º</text>
      </view>
      <view class="sidebar-item" bindtap="navigateToMyFollows">
        <text class="sidebar-icon">â¤ï¸</text>
        <text class="sidebar-text">æˆ‘å…³æ³¨çš„</text>
        <text class="sidebar-arrow">â€º</text>
      </view>
      <view class="sidebar-item" bindtap="navigateToMyFavorites">
        <text class="sidebar-icon">â­</text>
        <text class="sidebar-text">æˆ‘æ”¶è—çš„</text>
        <text class="sidebar-arrow">â€º</text>
      </view>
    </view>
  </view>

  <!-- èŠå¤©åˆ—è¡¨ -->
  <scroll-view class="chat-list" scroll-y refresher-enabled="{{true}}" refresher-triggered="{{refreshing}}" bindrefresherrefresh="onRefresh">
    
    <view class="chat-item-container {{item.isTouchMove ? 'touch-move-active' : ''}}" 
          wx:for="{{allChatList}}" 
          wx:key="id" 
          bindtouchstart="touchstart" 
          bindtouchmove="touchmove" 
          data-index="{{index}}">
      
      <!-- å†…å®¹åŒºåŸŸ -->
      <view class="chat-content-wrapper" bindtap="openChat" data-id="{{item.id}}" data-peerid="{{item.peerId}}" data-type="{{item.type || 'chat'}}">
        <view class="chat-avatar-wrapper">
          <image class="chat-avatar {{item.isSystemNotification ? 'system-notification-avatar' : ''}}" src="{{item.avatar}}" mode="aspectFill"></image>
          <view class="online-status" wx:if="{{item.isOnline}}"></view>
          <view class="unread-badge" wx:if="{{item.unreadCount > 0}}">{{item.unreadCount > 99 ? '99+' : item.unreadCount}}</view>
        </view>
        
        <view class="chat-info">
          <view class="chat-header">
            <view class="chat-name-wrap">
              <text class="chat-name">{{item.name}}</text>
              <text class="chat-tag" wx:if="{{item.isPinned}}">ç½®é¡¶</text>
            </view>
            <text class="chat-time">{{item.lastTime}}</text>
          </view>
          <view class="chat-preview">
            <text class="chat-message">{{item.lastMessage}}</text>
            <view class="chat-status-icons">
               <text class="chat-mute" wx:if="{{item.isMuted}}">ğŸ”‡</text>
            </view>
          </view>
        </view>
      </view>

      <!-- æ»‘åŠ¨æ“ä½œæŒ‰é’® -->
      <view class="action-buttons">
        <view class="action-btn pin {{item.isPinned ? 'unpin' : ''}}" catchtap="pinConversation" data-index="{{index}}" data-id="{{item.conversationId}}" data-ispinned="{{item.isPinned}}">
          {{item.isPinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶'}}
        </view>
        <view class="action-btn read" catchtap="markRead" data-index="{{index}}" data-peerid="{{item.peerId || item.userId}}">
          å·²è¯»
        </view>
        <view class="action-btn delete" catchtap="deleteConversation" data-index="{{index}}" data-id="{{item.conversationId}}">
          åˆ é™¤
        </view>
      </view>

    </view>
    
    <view class="empty-state" wx:if="{{allChatList.length === 0 && !loading}}">
      <text class="empty-text">æš‚æ— èŠå¤©è®°å½•</text>
    </view>
  </scroll-view>
</view>