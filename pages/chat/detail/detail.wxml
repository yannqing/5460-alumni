<!--pages/chat/detail/detail.wxml-->
<!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
<custom-nav-bar title="èŠå¤©" showBack="{{true}}"></custom-nav-bar>

<!-- æ¶ˆæ¯é€šçŸ¥ç»„ä»¶ -->
<message-notification />

<view class="chat-detail-page">
  <!-- æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view 
    class="message-list" 
    scroll-y 
    scroll-into-view="{{scrollIntoView}}"
    scroll-with-animation="{{true}}"
    enhanced
    show-scrollbar="{{false}}"
  >
    <view class="message-item" wx:for="{{messageList}}" wx:key="id" id="msg-{{item.id}}">
      <!-- ç³»ç»Ÿæ¶ˆæ¯/æ’¤å›æ¶ˆæ¯ -->
      <view class="message-system" wx:if="{{item.type === 'system' || item.isRecall}}">
        <text class="system-text">{{item.content}}</text>
      </view>

      <!-- å¯¹æ–¹æ¶ˆæ¯ -->
      <view class="message-row message-left" wx:elif="{{!item.isMe}}">
        <image class="message-avatar" src="{{chatInfo.avatar}}" mode="aspectFill" bindtap="viewProfile" data-type="{{chatType}}"></image>
        <view class="message-content-wrapper">
          <!-- å›¾ç‰‡æ¶ˆæ¯ -->
          <view class="message-bubble message-bubble-left" wx:if="{{item.type === 'image'}}">
            <image class="message-image" src="{{item.image}}" mode="aspectFill" bindtap="previewImage" data-url="{{item.image}}"></image>
            <text class="message-time message-time-inside">{{item.time}}</text>
          </view>
          <!-- ä½ç½®æ¶ˆæ¯ -->
          <view class="message-bubble message-bubble-left" wx:elif="{{item.type === 'location'}}">
            <view class="message-location">
              <text class="location-icon">ğŸ“</text>
              <view class="location-info">
                <text class="location-name">{{item.location.name}}</text>
                <text class="location-address">{{item.location.address}}</text>
              </view>
            </view>
            <text class="message-time message-time-inside">{{item.time}}</text>
          </view>
          <!-- åç‰‡æ¶ˆæ¯ -->
          <view class="message-bubble message-bubble-left" wx:elif="{{item.type === 'contact'}}">
            <view class="message-contact">
              <image class="contact-avatar" src="{{item.contact.avatar}}" mode="aspectFill"></image>
              <view class="contact-info">
                <text class="contact-name">{{item.contact.name}}</text>
                <text class="contact-school">{{item.contact.school}}</text>
              </view>
            </view>
            <text class="message-time message-time-inside">{{item.time}}</text>
          </view>
          <!-- æ™®é€šæ–‡æœ¬æ¶ˆæ¯ -->
          <view class="message-bubble message-bubble-left" wx:else>
            <text class="message-text">{{item.content}}</text>
            <text class="message-time message-time-inside">{{item.time}}</text>
          </view>
        </view>
      </view>
      
      <!-- æˆ‘çš„æ¶ˆæ¯ -->
      <view class="message-row message-right" wx:else>
        <view class="message-content-wrapper" bindlongpress="onLongPressMessage" data-msg="{{item}}">
          <!-- å›¾ç‰‡æ¶ˆæ¯ -->
          <view class="message-bubble message-bubble-right" wx:if="{{item.type === 'image'}}">
            <image class="message-image" src="{{item.image}}" mode="aspectFill" bindtap="previewImage" data-url="{{item.image}}"></image>
            <text class="message-time message-time-inside message-time-right">{{item.time}}</text>
          </view>
          <!-- ä½ç½®æ¶ˆæ¯ -->
          <view class="message-bubble message-bubble-right" wx:elif="{{item.type === 'location'}}">
            <view class="message-location">
              <text class="location-icon">ğŸ“</text>
              <view class="location-info">
                <text class="location-name">{{item.location.name}}</text>
                <text class="location-address">{{item.location.address}}</text>
              </view>
            </view>
            <text class="message-time message-time-inside message-time-right">{{item.time}}</text>
          </view>
          <!-- åç‰‡æ¶ˆæ¯ -->
          <view class="message-bubble message-bubble-right" wx:elif="{{item.type === 'contact'}}">
            <view class="message-contact">
              <image class="contact-avatar" src="{{item.contact.avatar}}" mode="aspectFill"></image>
              <view class="contact-info">
                <text class="contact-name">{{item.contact.name}}</text>
                <text class="contact-school">{{item.contact.school}}</text>
              </view>
            </view>
            <text class="message-time message-time-inside message-time-right">{{item.time}}</text>
          </view>
          <!-- æ™®é€šæ–‡æœ¬æ¶ˆæ¯ -->
          <view class="message-bubble message-bubble-right" wx:else>
            <text class="message-text">{{item.content}}</text>
            <text class="message-time message-time-inside message-time-right">{{item.time}}</text>
          </view>
        </view>
        <image class="message-avatar" src="{{myAvatar}}" mode="aspectFill"></image>
      </view>
    </view>
  </scroll-view>

  <!-- è¾“å…¥æ  -->
  <view class="input-bar">
    <view class="input-wrapper">
      <input 
        class="message-input" 
        placeholder="è¾“å…¥æ¶ˆæ¯..." 
        value="{{inputValue}}"
        bindinput="onInput"
        bindconfirm="sendMessage"
        confirm-type="send"
        adjust-position="{{true}}"
      />
      <view class="input-actions">
        <view class="action-btn" bindtap="toggleEmoji">
          <text class="action-icon">ğŸ˜Š</text>
        </view>
        <view class="action-btn" bindtap="sendMessage" wx:if="{{hasInput}}">
          <text class="action-icon send-btn">å‘é€</text>
        </view>
        <view class="action-btn" bindtap="showMoreActions" wx:else>
          <text class="action-icon">+</text>
        </view>
      </view>
    </view>
  </view>

  <!-- è¡¨æƒ…é€‰æ‹©é¢æ¿ -->
  <view class="emoji-panel {{showEmoji ? 'show' : ''}}">
    <scroll-view class="emoji-scroll" scroll-y>
      <view class="emoji-grid">
        <view class="emoji-item" wx:for="{{emojiList}}" wx:key="*this" bindtap="insertEmoji" data-emoji="{{item}}">
          <text class="emoji-text">{{item}}</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æ›´å¤šåŠŸèƒ½èœå• -->
  <view class="more-menu-mask {{showMoreMenu ? 'show' : ''}}" bindtap="hideMoreMenu"></view>
  <view class="more-menu {{showMoreMenu ? 'show' : ''}}">
    <view class="more-menu-item" bindtap="selectImage">
      <view class="more-menu-icon">ğŸ“·</view>
      <text class="more-menu-text">å›¾ç‰‡</text>
    </view>
    <view class="more-menu-item" bindtap="selectLocation">
      <view class="more-menu-icon">ğŸ“</view>
      <text class="more-menu-text">ä½ç½®</text>
    </view>
    <view class="more-menu-item" bindtap="selectContact">
      <view class="more-menu-icon">ğŸ‘¤</view>
      <text class="more-menu-text">åç‰‡</text>
    </view>
    <view class="more-menu-cancel" bindtap="hideMoreMenu">
      <text>å–æ¶ˆ</text>
    </view>
  </view>
</view>

