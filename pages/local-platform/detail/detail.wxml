<!--pages/local-platform/detail/detail.wxml-->
<view class="container">
  <view wx:if="{{loading}}" class="loading-wrap">
    <view class="loading">加载中...</view>
  </view>

  <view wx:elif="{{platformInfo}}">
    <!-- 顶部封面 + 头像，与校友会主页风格保持一致 -->
    <image class="cover-image" src="{{platformInfo.cover}}" mode="aspectFill" />

    <view class="card">
      <view class="flex">
        <image class="avatar avatar-large" src="{{platformInfo.icon}}" mode="aspectFill" />
        <view class="flex-1 ml-20">
          <view class="name-row">
            <text class="text-primary text-bold">{{platformInfo.platformName}}</text>
          </view>
          <view wx:if="{{platformInfo.city}}" class="text-secondary mt-10 location-row">
            <image class="location-icon" src="{{iconLocation}}" mode="aspectFit" />
            <text>{{platformInfo.city}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 顶部 Tab，与校友会主页一致：基本信息 / 成员列表 -->
    <view class="tabs">
      <view
        class="tab-item {{activeTab === index ? 'active' : ''}}"
        wx:for="{{tabs}}"
        wx:key="*this"
        bindtap="switchTab"
        data-index="{{index}}"
      >
        {{item}}
      </view>
    </view>

    <!-- Tab 内容：基本信息 -->
    <view wx:if="{{activeTab === 0}}" class="tab-content">
      <view class="card">
        <view class="text-bold mb-20">基本信息</view>
        <view wx:if="{{platformInfo.description}}" class="text-secondary">{{platformInfo.description}}</view>
        <view class="divider"></view>
        <view class="text-secondary">联系信息：{{platformInfo.contactInfo || '暂无'}}</view>
        <view class="text-secondary mt-10" wx:if="{{platformInfo.city}}">
          所在城市：{{platformInfo.city}}
        </view>
        <view class="text-secondary mt-10" wx:if="{{platformInfo.memberCount}}">
          会员：{{platformInfo.memberCount}}人
        </view>
      </view>
    </view>

    <!-- Tab 内容：组织结构 -->
    <view wx:if="{{activeTab === 1}}" class="tab-content">
      <view class="card dashboard-card">
        <view class="section-header">
          <view class="section-title">
            <view class="text-bold">组织结构</view>
            <view class="section-subtitle">组织架构展示</view>
          </view>
        </view>
        
        <view class="role-list-section">
          <!-- 骨架屏 -->
          <view wx:if="{{organizationLoading}}" class="skeleton-role-list">
            <view class="role-item skeleton-item" wx:for="[1,2,3]" wx:key="*this">
              <view class="role-header">
                <view class="role-name-container">
                  <text class="expand-icon">▶</text>
                  <view class="skeleton-role-name"></view>
                </view>
                <view class="skeleton-role-count"></view>
              </view>
            </view>
          </view>
          
          <!-- 空状态 -->
          <view wx:elif="{{roleList.length === 0}}" class="empty-container">
            <text class="empty-text">暂无角色数据</text>
          </view>
          
          <view wx:else class="org-tree">
            <!-- 一级节点 -->
            <view wx:for="{{roleList}}" wx:key="uniqueId" wx:for-item="node1" class="tree-node level-1">
              <view class="node-header" bindtap="toggleExpand" data-id="{{node1.uniqueId}}">
                <view class="node-title">
                  <text class="expand-icon {{node1.expanded ? 'expanded' : ''}}">▶</text>
                  <text class="role-name">{{node1.roleOrName}}</text>
                </view>
                <view class="node-meta">
                  <text class="member-count">{{node1.members.length}}人</text>
                </view>
              </view>
              
              <view class="node-content" wx:if="{{node1.expanded}}">
                <!-- 一级节点成员 -->
                <view class="node-members" wx:if="{{node1.members.length > 0}}">
                  <view class="org-member-grid">
                    <view class="org-member-item" wx:for="{{node1.members}}" wx:key="wxId" wx:for-item="member">
                      <image class="org-member-avatar" src="{{member.avatarUrl}}" mode="aspectFill"></image>
                      <view class="org-member-info">
                        <text class="org-member-name">{{member.name || member.nickname}}</text>
                        <text class="org-member-role">{{node1.roleOrName}}</text>
                      </view>
                    </view>
                  </view>
                </view>
                
                <!-- 二级节点 -->
                <view class="children-nodes" wx:if="{{node1.children && node1.children.length > 0}}">
                  <view wx:for="{{node1.children}}" wx:key="uniqueId" wx:for-item="node2" class="tree-node level-2">
                    <view class="node-header" bindtap="toggleExpand" data-id="{{node2.uniqueId}}">
                      <view class="node-title">
                        <text class="expand-icon {{node2.expanded ? 'expanded' : ''}}">▶</text>
                        <text class="role-name">{{node2.roleOrName}}</text>
                      </view>
                      <view class="node-meta">
                        <text class="member-count">{{node2.members.length}}人</text>
                      </view>
                    </view>
                    
                    <view class="node-content" wx:if="{{node2.expanded}}">
                      <!-- 二级节点成员 -->
                       <view class="node-members" wx:if="{{node2.members.length > 0}}">
                        <view class="org-member-grid">
                          <view class="org-member-item" wx:for="{{node2.members}}" wx:key="wxId" wx:for-item="member">
                            <image class="org-member-avatar" src="{{member.avatarUrl}}" mode="aspectFill"></image>
                            <view class="org-member-info">
                              <text class="org-member-name">{{member.name || member.nickname}}</text>
                              <text class="org-member-role">{{node2.roleOrName}}</text>
                            </view>
                          </view>
                        </view>
                      </view>
                      
                      <!-- 三级节点 -->
                      <view class="children-nodes" wx:if="{{node2.children && node2.children.length > 0}}">
                        <view wx:for="{{node2.children}}" wx:key="uniqueId" wx:for-item="node3" class="tree-node level-3">
                          <view class="node-header" bindtap="toggleExpand" data-id="{{node3.uniqueId}}">
                            <view class="node-title">
                              <text class="expand-icon {{node3.expanded ? 'expanded' : ''}}">▶</text>
                              <text class="role-name">{{node3.roleOrName}}</text>
                            </view>
                            <view class="node-meta">
                              <text class="member-count">{{node3.members.length}}人</text>
                            </view>
                          </view>
                          
                          <view class="node-content" wx:if="{{node3.expanded}}">
                            <!-- 三级节点成员 -->
                             <view class="node-members" wx:if="{{node3.members.length > 0}}">
                              <view class="org-member-grid">
                                <view class="org-member-item" wx:for="{{node3.members}}" wx:key="wxId" wx:for-item="member">
                                  <image class="org-member-avatar" src="{{member.avatarUrl}}" mode="aspectFill"></image>
                                  <view class="org-member-info">
                                    <text class="org-member-name">{{member.name || member.nickname}}</text>
                                    <text class="org-member-role">{{node3.roleOrName}}</text>
                                  </view>
                                </view>
                              </view>
                            </view>
                          </view>
                        </view>
                      </view>
                    </view>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- Tab 内容：会员列表 -->
    <view wx:if="{{activeTab === 2}}" class="tab-content">
      <view class="card">
        <view class="text-bold mb-20">会员列表</view>
        <!-- 骨架屏 -->
        <view wx:if="{{associationLoading && associations.length === 0}}" class="member-list skeleton-list">
          <view class="member-item skeleton-item" wx:for="[1,2,3,4,5]" wx:key="*this">
            <view class="member-avatar skeleton-avatar"></view>
            <view class="member-info">
              <view class="member-name-row">
                <view class="skeleton-name"></view>
              </view>
              <view class="skeleton-text"></view>
              <view class="skeleton-text"></view>
            </view>
          </view>
        </view>
        <!-- 空状态 -->
        <view wx:elif="{{!associations.length}}" class="text-placeholder">暂无校友会</view>
        <!-- 实际数据 -->
        <view wx:else class="member-list">
          <view class="member-item" wx:for="{{associations}}" wx:key="associationId" bindtap="viewAssociationDetail" data-id="{{item.associationId}}">
            <image class="member-avatar" src="{{item.avatar}}" mode="aspectFill" />
            <view class="member-info">
              <view class="member-name-row">
                <text class="member-name">{{item.associationName}}</text>
              </view>
              <view class="member-company">会员人数：{{item.memberCount}}人</view>
              <view class="member-company">所在地：{{item.location || '暂无'}}</view>
            </view>
          </view>
        </view>
        <!-- 加载更多 -->
        <view wx:if="{{associationLoading && associations.length > 0}}" class="loading-more">加载中...</view>
        <view wx:elif="{{!hasMore && associations.length}}" class="no-more">没有更多了</view>
      </view>
    </view>
  </view>

  <view wx:else class="empty-state">
    <view class="empty-placeholder">暂无数据</view>
    <text>暂无校处会信息</text>
  </view>
</view>


