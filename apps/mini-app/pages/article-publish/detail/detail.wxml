<!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
<custom-nav-bar showBack="{{true}}" useAuditStyle="{{true}}" auditTitle="æ–‡ç« è¯¦æƒ…">

<!-- æ¶ˆæ¯é€šçŸ¥ç»„ä»¶ -->
<message-notification />

<scroll-view class="container" scroll-y enable-back-to-top>
  <!-- éª¨æ¶å±åŠ è½½çŠ¶æ€ -->
  <view class="skeleton-container" wx:if="{{loading}}">
    <view class="skeleton-header">
      <view class="skeleton-avatar skeleton-animate"></view>
      <view class="skeleton-user-info">
        <view class="skeleton-name skeleton-animate"></view>
        <view class="skeleton-time skeleton-animate"></view>
      </view>
    </view>
    <view class="skeleton-title skeleton-animate"></view>
    <view class="skeleton-cover skeleton-animate"></view>
    <view class="skeleton-content">
      <view class="skeleton-line skeleton-animate"></view>
      <view class="skeleton-line skeleton-animate" style="width: 85%;"></view>
      <view class="skeleton-line skeleton-animate" style="width: 70%;"></view>
    </view>
  </view>

  <!-- æ–‡ç« å†…å®¹ -->
  <block wx:elif="{{article}}">
    <!-- ä¸»å¡ç‰‡ -->
    <view class="main-card">
      <!-- å‘å¸ƒè€…ä¿¡æ¯ -->
      <view class="publisher-section">
        <image class="publisher-avatar" src="{{article.publisherAvatar}}" mode="aspectFill" wx:if="{{article.publisherAvatar}}"></image>
        <view class="publisher-avatar placeholder" wx:else>
          <text class="placeholder-icon">U</text>
        </view>
        <view class="publisher-info">
          <text class="publisher-name">{{article.publishUsername || article.author || 'å®˜æ–¹å‘å¸ƒ'}}</text>
          <text class="publish-time">{{article.createTime || article.time}}</text>
        </view>
        <!-- å®¡æ ¸çŠ¶æ€æ ‡ç­¾ -->
        <view class="status-tag {{article.applyStatusClass}}" wx:if="{{article.applyStatusText}}">
          <text class="status-text">{{article.applyStatusText}}</text>
        </view>
      </view>

      <!-- åˆ†å‰²çº¿ -->
      <view class="divider"></view>

      <!-- æ–‡ç« æ ‡é¢˜ -->
      <view class="title-section" wx:if="{{article.title}}">
        <text class="article-title">{{article.title}}</text>
      </view>

      <!-- å°é¢å›¾ç‰‡ -->
      <view class="cover-section" wx:if="{{article.cover}}">
        <image class="article-cover" src="{{article.cover}}" mode="widthFix" bindtap="previewImage" data-url="{{article.cover}}"></image>
      </view>

      <!-- æ–‡ç« æè¿°/å†…å®¹ -->
      <view class="content-section" wx:if="{{article.content || article.description}}">
        <rich-text nodes="{{article.content || article.description}}"></rich-text>
      </view>

      <!-- æ–‡ç« é“¾æ¥ -->
      <view class="link-section" wx:if="{{article.articleLink}}">
        <view class="link-icon-wrapper">
          <text class="link-icon">ğŸ”—</text>
        </view>
        <view class="link-content">
          <text class="link-label">ç›¸å…³é“¾æ¥</text>
          <text class="link-url" bindtap="openLink" data-link="{{article.articleLink}}">{{article.articleLink}}</text>
        </view>
      </view>
    </view>

    <!-- å­æ–‡ç« åˆ—è¡¨ -->
    <view class="children-section" wx:if="{{article.children && article.children.length > 0}}">
      <view class="section-header">
        <view class="section-title-wrapper">
          <view class="section-indicator"></view>
          <text class="section-title">å­æ–‡ç« åˆ—è¡¨</text>
        </view>
        <text class="section-count">å…± {{article.children.length}} ç¯‡</text>
      </view>

      <view class="children-list">
        <view class="child-card" wx:for="{{article.children}}" wx:key="homeArticleId" bindtap="viewChildDetail" data-id="{{item.homeArticleId}}">
          <view class="child-content">
            <text class="child-title">{{item.articleTitle || 'æ— æ ‡é¢˜'}}</text>
            <text class="child-desc" wx:if="{{item.description}}">{{item.description}}</text>
            <view class="child-meta">
              <text class="child-time">{{item.createTimeFormatted || item.createTime}}</text>
              <view class="child-status {{item.applyStatusClass}}" wx:if="{{item.applyStatusText}}">
                <text class="child-status-text">{{item.applyStatusText}}</text>
              </view>
            </view>
          </view>
          <image class="child-cover" src="{{item.coverUrl}}" mode="aspectFill" wx:if="{{item.coverUrl}}"></image>
          <view class="child-cover placeholder" wx:else></view>
        </view>
      </view>
    </view>

    <!-- æ›´æ–°æ—¶é—´ -->
    <view class="update-info" wx:if="{{article.updateTime}}">
      <text class="update-label">æœ€åæ›´æ–°ï¼š{{article.updateTime}}</text>
    </view>
  </block>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view wx:else class="error-state">
    <view class="error-icon">ğŸ“„</view>
    <view class="error-text">æ–‡ç« ä¸å­˜åœ¨æˆ–å·²åˆ é™¤</view>
    <view class="error-btn" bindtap="goBack">è¿”å›ä¸Šä¸€é¡µ</view>
  </view>

  <!-- åº•éƒ¨å ä½ -->
  <view class="bottom-placeholder" wx:if="{{canEdit && article}}"></view>
</scroll-view>

<!-- åº•éƒ¨æ“ä½œæŒ‰é’®åŒºåŸŸ -->
<view class="action-btn-container" wx:if="{{canEdit && article}}">
  <!-- å¾…å®¡æ ¸çŠ¶æ€ä¸”æœ‰å®¡æ ¸æƒé™ï¼šæ˜¾ç¤ºé€šè¿‡å’Œæ‹’ç»æŒ‰é’® -->
  <block wx:if="{{article.applyStatus === 0 && canReview}}">
    <view class="action-btn approve-btn" bindtap="onApproveTap">
      <text class="action-btn-text approve-text">é€šè¿‡</text>
    </view>
    <view class="action-btn reject-btn" bindtap="onRejectTap">
      <text class="action-btn-text reject-text">æ‹’ç»</text>
    </view>
  </block>
  <!-- éå¾…å®¡æ ¸çŠ¶æ€æˆ–æ²¡æœ‰å®¡æ ¸æƒé™ï¼šæ˜¾ç¤ºç¼–è¾‘å’Œåˆ é™¤æŒ‰é’® -->
  <block wx:else>
    <view class="action-btn edit-action-btn" bindtap="onEditTap">
      <text class="action-btn-text edit-text">ç¼–è¾‘</text>
    </view>
    <view class="action-btn delete-btn" bindtap="onDeleteTap">
      <text class="action-btn-text delete-text">åˆ é™¤</text>
    </view>
  </block>
</view>

<!-- å®¡æ ¸å¼¹æ¡† -->
<view class="modal-overlay" wx:if="{{isApprovalModalVisible}}" bindtap="hideApprovalModal"></view>
<view class="approval-modal" wx:if="{{isApprovalModalVisible}}">
  <view class="modal-header">
    <text class="modal-title">{{approvalAction === 1 ? 'å®¡æ ¸é€šè¿‡' : 'å®¡æ ¸æ‹’ç»'}}</text>
    <text class="modal-close" bindtap="hideApprovalModal">Ã—</text>
  </view>
  <view class="modal-content">
    <view class="form-item">
      <text class="form-label">å®¡æ ¸è¯´æ˜</text>
      <textarea
        class="form-textarea"
        placeholder="è¯·è¾“å…¥å®¡æ ¸è¯´æ˜ï¼ˆå¯é€‰ï¼‰"
        value="{{approvalForm.appliedDescription}}"
        data-field="appliedDescription"
        bindinput="onApprovalInput"
      ></textarea>
    </view>
  </view>
  <view class="modal-footer">
    <button class="modal-btn cancel-btn" bindtap="hideApprovalModal">å–æ¶ˆ</button>
    <button class="modal-btn confirm-btn {{approvalAction === 2 ? 'reject-confirm-btn' : ''}}" bindtap="submitApproval">ç¡®å®š</button>
  </view>
</view>

</custom-nav-bar>
