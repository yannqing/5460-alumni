<!--pages/alumni-association/member/member.wxml-->
<custom-nav-bar showBack="{{true}}" useAuditStyle="{{true}}" auditTitle="校友会成员">
<view class="page">
  <!-- 校友会选择卡片（与城市/校促会成员管理一致，固定不滚动） -->
  <view class="group_5" wx:if="{{!hasSingleAlumniAssociation && hasAlumniAdminPermission}}">
    <text class="text_14">校友会组织</text>
    <text class="label_text">选择校友会</text>
    <view class="text-wrapper_8" bindtap="showAlumniAssociationSelector">
      <text class="text_15">{{selectedAlumniAssociationName || '请选择校友会'}}</text>
    </view>
  </view>

  <!-- 成员列表卡片（与城市成员管理一致：固定标题，仅内部 scroll-list 滚动） -->
  <view class="group_7">
    <view class="member-list-header">
      <text class="text_20">成员列表</text>
      <view class="invite-btn-wrap">
        <button class="invite-btn" bindtap="showInviteModal">+邀请加入</button>
      </view>
    </view>
    <scroll-view class="scroll-list" scroll-y enable-back-to-top enhanced show-scrollbar="{{false}}">
      <view wx:if="{{memberLoading}}" class="loading-state">
        <text>加载成员中...</text>
      </view>
      <view class="member-list" wx:else>
        <view class="member-item" wx:for="{{memberList}}" wx:key="wxId">
          <view class="member-item-left">
            <view class="member-avatar">
              <image class="avatar-img" src="{{item.avatarUrl || 'https://cni-alumni.yannqing.com/upload/images/assets/images/avatar.png'}}"></image>
            </view>
            <view class="member-text-group">
              <text class="member-name">{{item.name || item.nickname || '未命名'}}</text>
              <text class="member-gender-text" wx:if="{{item.gender}}">{{item.gender === 1 ? '男' : '女'}}</text>
            </view>
          </view>
          <view class="member-role-tag">{{item.organizeArchiRole && item.organizeArchiRole.roleOrName ? item.organizeArchiRole.roleOrName : '普通成员'}}</view>
          <view class="member-actions">
            <view class="edit-btn" catchtap="openEditModal" data-member="{{item}}">编辑</view>
            <view class="delete-btn" catchtap="deleteMember" data-member="{{item}}">删除</view>
          </view>
        </view>
        <view class="empty-state" wx:if="{{memberList.length === 0}}">
          <text>{{selectedAlumniAssociationId ? '暂无成员数据' : '请先选择校友会'}}</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- 校友会选择器弹窗 -->
  <view class="alumni-association-picker" wx:if="{{showAlumniAssociationPicker}}">
    <view class="picker-overlay" bindtap="cancelAlumniAssociationSelect"></view>
    <view class="picker-content">
      <view class="picker-header">
        <text class="picker-title">选择校友会</text>
        <text class="picker-cancel" bindtap="cancelAlumniAssociationSelect">取消</text>
      </view>
      <view class="picker-list">
        <view
          class="picker-item"
          wx:for="{{alumniAssociationList}}"
          wx:key="alumniAssociationId"
          data-alumni-association-id="{{item.alumniAssociationId}}"
          data-alumni-association-name="{{item.alumniAssociationName}}"
          bindtap="selectAlumniAssociation"
        >
          <text class="item-name">{{item.alumniAssociationName}}</text>
          <text class="item-check" wx:if="{{selectedAlumniAssociationId == item.alumniAssociationId}}">✓</text>
        </view>
        <view class="picker-empty" wx:if="{{alumniAssociationList.length === 0}}">
          <text>暂无校友会数据</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 邀请成员弹窗 -->
  <view class="invite-modal" wx:if="{{showInviteModal}}">
    <view class="modal-overlay" bindtap="hideInviteModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">邀请成员加入</text>
        <text class="modal-close" bindtap="hideInviteModal">×</text>
      </view>
      <view class="modal-body">
        <view class="alumni-name-field" catchtap="preventBubble">
          <view class="field-label">校友姓名</view>
          <view class="field-input-wrapper">
            <input
              class="field-input"
              placeholder="请输入校友姓名进行搜索"
              placeholder-class="field-placeholder"
              adjust-position="{{false}}"
              bindinput="onMemberNameInput"
              bindfocus="onMemberNameFocus"
              value="{{inviteForm.name}}"
            />
          </view>
          <scroll-view scroll-y class="alumni-search-dropdown" show-scrollbar="{{false}}" wx:if="{{showAlumniSearchResults && alumniSearchResults.length > 0}}">
            <view wx:for="{{alumniSearchResults}}" wx:key="userId" class="alumni-search-item" bindtap="selectAlumni" data-index="{{index}}">
              <image wx:if="{{item.avatarUrl}}" src="{{item.avatarUrl}}" class="alumni-avatar" mode="aspectFill" />
              <image wx:else src="https://cni-alumni.yannqing.com/upload/images/assets/images/avatar.png" class="alumni-avatar" mode="aspectFill" />
              <view class="alumni-item-info">
                <text class="alumni-item-name">{{item.name || item.nickname || item.realName}}</text>
                <text class="alumni-item-school">{{item.school || '暂无学校信息'}}</text>
              </view>
            </view>
          </scroll-view>
        </view>
        <view class="form-item">
          <text class="label">校友会身份</text>
          <picker bindchange="onRoleChange" range="{{roleList}}" range-key="roleOrName" value="{{inviteForm.roleIndex || 0}}">
            <view class="role-selector">
              <text class="selector-text">{{inviteForm.roleOrName || '请选择身份'}}</text>
              <text class="selector-arrow">▼</text>
            </view>
          </picker>
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn btn-cancel" bindtap="hideInviteModal">取消</button>
        <button class="btn btn-confirm" bindtap="submitInvite">确定邀请</button>
      </view>
    </view>
  </view>

  <!-- 编辑成员角色弹窗 -->
  <view class="edit-modal" wx:if="{{showEditModal}}">
    <view class="modal-overlay" bindtap="hideEditModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">编辑成员角色</text>
        <text class="modal-close" bindtap="hideEditModal">×</text>
      </view>
      <view class="modal-body">
        <view class="form-item">
          <text class="label">成员姓名</text>
          <view class="member-info-display">
            <image class="avatar-small" src="{{editingMember.avatarUrl || 'https://cni-alumni.yannqing.com/upload/images/assets/images/avatar.png'}}"></image>
            <text class="member-name-display">{{editingMember.name || editingMember.nickname || '未命名'}}</text>
          </view>
        </view>
        <view class="form-item">
          <text class="label">校友会身份</text>
          <picker bindchange="onEditRoleChange" range="{{roleList}}" range-key="roleOrName" value="{{editingMember.roleIndex || 0}}">
            <view class="role-selector">
              <text class="selector-text">{{editingMember.newRoleName || (editingMember.organizeArchiRole && editingMember.organizeArchiRole.roleOrName) || '请选择身份'}}</text>
              <text class="selector-arrow">▼</text>
            </view>
          </picker>
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn btn-cancel" bindtap="hideEditModal">取消</button>
        <button class="btn btn-confirm" bindtap="submitEdit">保存</button>
      </view>
    </view>
  </view>
</view>
</custom-nav-bar>
