<!--pages/merchant/apply/apply.wxml-->
<!-- 自定义导航栏 -->
<custom-nav-bar title="商户申请" showBack="{{true}}"></custom-nav-bar>

<view class="apply-container">
  <scroll-view scroll-y class="form-scroll">
    <!-- 申请状态提示 -->
    <view class="status-card card" wx:if="{{merchantStatus === 'pending'}}">
      <view class="status-icon">⏳</view>
      <view class="status-title">申请审核中</view>
      <view class="status-desc">我们正在审核您的商家申请，请耐心等待</view>
    </view>
    
    <view class="status-card card" wx:elif="{{merchantStatus === 'approved'}}">
      <view class="status-icon verified">✓</view>
      <view class="status-title">申请已通过</view>
      <view class="status-desc">恭喜您成为认证商家，可以开始管理店铺了</view>
    </view>
    
    <view class="status-card card" wx:elif="{{merchantStatus === 'rejected'}}">
      <view class="status-icon rejected">✗</view>
      <view class="status-title">申请未通过</view>
      <view class="status-desc">您的申请未通过审核，请检查信息后重新提交</view>
    </view>
    
    <!-- 填写说明 -->
    <view class="tip-card card" wx:if="{{merchantStatus === 'none' || merchantStatus === 'rejected'}}">
      <view class="tip-title">📋 申请说明</view>
      <view class="tip-list">
        <text>1. 请确保填写的信息真实有效</text>
        <text>2. 需要上传清晰的营业执照照片</text>
        <text>3. 审核通常需要1-3个工作日</text>
        <text>4. 通过后可发布优惠券、管理店铺等</text>
      </view>
    </view>

    <!-- 商户信息 -->
    <view class="section-card card">
      <view class="section-title">商户信息</view>
      
      <view class="form-item">
        <view class="label">商户名称 <text class="required">*</text></view>
        <input class="input" placeholder="请输入商户名称" value="{{form.merchantName}}" data-field="merchantName" bindinput="handleInput" />
      </view>
      
      <view class="form-item">
        <view class="label">商户类型 <text class="required">*</text></view>
        <picker mode="selector" range="{{merchantTypeOptions}}" range-key="label" value="{{merchantTypeIndex}}" bindchange="handleMerchantTypeChange">
          <view class="picker-value">{{merchantTypeOptions[merchantTypeIndex].label}}</view>
        </picker>
      </view>
      
      <view class="form-item">
        <view class="label">统一社会信用代码 <text class="required">*</text></view>
        <input class="input" placeholder="请输入统一社会信用代码" value="{{form.unifiedSocialCreditCode}}" data-field="unifiedSocialCreditCode" bindinput="handleInput" />
      </view>
      
      <view class="form-item">
        <view class="label">经营范围</view>
        <input class="input" placeholder="请输入经营范围" value="{{form.businessScope}}" data-field="businessScope" bindinput="handleInput" />
      </view>
      
      <view class="form-item">
        <view class="label">经营类目</view>
        <input class="input" placeholder="请输入经营类目" value="{{form.businessCategory}}" data-field="businessCategory" bindinput="handleInput" />
      </view>
      
      <view class="form-item" wx:if="{{form.merchantType === 1}}">
        <view class="label">关联校友会 <text class="required">*</text></view>
        <view class="association-selector" bindtap="showAssociationSearch">
          <text class="input" wx:if="{{form.selectedAlumniAssociation}}">{{form.selectedAlumniAssociation.associationName}}</text>
          <text class="input placeholder" wx:else>请搜索并选择校友会</text>
          <text class="select-icon">▼</text>
        </view>
      </view>
      
      <!-- 校友会搜索弹窗 -->
      <view class="search-popup" wx:if="{{showAssociationSearch}}">
        <view class="popup-overlay" bindtap="hideAssociationSearch"></view>
        <view class="popup-content">
          <view class="popup-header">
            <view class="header-title">选择校友会</view>
            <view class="close-btn" bindtap="hideAssociationSearch">✕</view>
          </view>
          
          <!-- 搜索框 -->
          <view class="search-input-wrapper">
            <input 
              class="search-input" 
              placeholder="请输入校友会名称搜索" 
              value="{{associationSearchText}}" 
              bindinput="onAssociationSearchInput" 
              bindconfirm="searchAssociations" 
            />
            <button class="search-btn" bindtap="searchAssociations" loading="{{associationLoading}}">搜索</button>
          </view>
          
          <!-- 搜索结果 -->
          <scroll-view scroll-y class="association-list" style="height: 400rpx;">
            <view class="list-empty" wx:if="{{associationList.length === 0 && !associationLoading}}">
              <text>暂无搜索结果</text>
            </view>
            <view class="association-item" wx:for="{{associationList}}" wx:key="alumniAssociationId" bindtap="selectAssociation" data-item="{{item}}">
              <view class="association-info">
                <view class="association-name">{{item.associationName}}</view>
                <view class="association-location">{{item.location}}</view>
              </view>
              <view class="member-count">会员数：{{item.memberCount}}</view>
            </view>
          </scroll-view>
        </view>
      </view>
    </view>

    <!-- 法人信息 -->
    <view class="section-card card">
      <view class="section-title">法人信息</view>
      
      <view class="form-item">
        <view class="label">法人姓名 <text class="required">*</text></view>
        <input class="input" placeholder="请输入法人姓名" value="{{form.legalPerson}}" data-field="legalPerson" bindinput="handleInput" />
      </view>
      
      <view class="form-item">
        <view class="label">法人身份证号 <text class="required">*</text></view>
        <input class="input" placeholder="请输入法人身份证号" value="{{form.legalPersonId}}" data-field="legalPersonId" bindinput="handleInput" />
      </view>
    </view>

    <!-- 联系信息 -->
    <view class="section-card card">
      <view class="section-title">联系信息</view>
      
      <view class="form-item">
        <view class="label">联系电话 <text class="required">*</text></view>
        <input class="input" placeholder="请输入联系电话" value="{{form.contactPhone}}" data-field="contactPhone" bindinput="handleInput" />
      </view>
      
      <view class="form-item">
        <view class="label">联系邮箱</view>
        <input class="input" placeholder="请输入联系邮箱" value="{{form.contactEmail}}" data-field="contactEmail" bindinput="handleInput" />
      </view>
    </view>

    <!-- 资质证明 -->
    <view class="section-card card">
      <view class="section-title">资质证明</view>
      
      <!-- 营业执照 -->
      <view class="upload-section">
        <view class="upload-label">
          <text class="label-text">营业执照</text>
          <text class="required">*</text>
        </view>
        <view class="upload-hint">请上传清晰的营业执照照片，确保信息完整可见</view>
        <view class="upload-area" wx:if="{{!form.businessLicense}}" bindtap="chooseImage">
          <view class="upload-icon">📷</view>
          <view class="upload-text">点击上传营业执照</view>
        </view>
        <view class="image-preview" wx:else>
          <image class="preview-image" src="{{form.businessLicense}}" mode="aspectFit" />
          <view class="remove-btn" bindtap="removeImage" data-field="businessLicense">✕</view>
        </view>
      </view>
    </view>

    <!-- 底部留白 -->
    <view class="bottom-space"></view>
  </scroll-view>

  <!-- 提交按钮 -->
  <view class="bottom-action">
    <button class="btn btn-primary" loading="{{submitting}}" bindtap="submitApply">提交申请</button>
  </view>
</view>



