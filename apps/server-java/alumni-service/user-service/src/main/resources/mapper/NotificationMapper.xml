<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cmswe.alumni.service.user.mapper.NotificationMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.cmswe.alumni.common.entity.Notification">
        <id property="notificationId" column="notification_id" jdbcType="BIGINT"/>
        <result property="messageId" column="message_id" jdbcType="VARCHAR"/>
        <result property="messageType" column="message_type" jdbcType="VARCHAR"/>
        <result property="fromUserId" column="from_user_id" jdbcType="BIGINT"/>
        <result property="fromUsername" column="from_username" jdbcType="VARCHAR"/>
        <result property="toUserId" column="to_user_id" jdbcType="BIGINT"/>
        <result property="title" column="title" jdbcType="VARCHAR"/>
        <result property="content" column="content" jdbcType="VARCHAR"/>
        <result property="relatedId" column="related_id" jdbcType="BIGINT"/>
        <result property="relatedType" column="related_type" jdbcType="VARCHAR"/>
        <result property="readStatus" column="read_status" jdbcType="TINYINT"/>
        <result property="readTime" column="read_time" jdbcType="TIMESTAMP"/>
        <result property="extraData" column="extra_data" jdbcType="VARCHAR"/>
        <result property="createdTime" column="created_time" jdbcType="TIMESTAMP"/>
        <result property="updatedTime" column="updated_time" jdbcType="TIMESTAMP"/>
        <result property="isDeleted" column="is_deleted" jdbcType="TINYINT"/>
    </resultMap>

    <!-- 统计结果映射 -->
    <resultMap id="StatisticResultMap" type="com.cmswe.alumni.common.dto.NotificationStatistic">
        <result property="messageType" column="message_type" jdbcType="VARCHAR"/>
        <result property="count" column="count" jdbcType="INTEGER"/>
    </resultMap>

    <!-- 基础列 -->
    <sql id="Base_Column_List">
        notification_id, message_id, message_type, from_user_id, from_username,
        to_user_id, title, content, related_id, related_type,
        read_status, read_time, extra_data, created_time, updated_time, is_deleted
    </sql>

    <!-- 查询用户未读通知数量 -->
    <select id="countUnreadByUserId" resultType="int">
        SELECT COUNT(*)
        FROM notification
        WHERE to_user_id = #{userId}
          AND read_status = 0
          AND is_deleted = 0
    </select>

    <!-- 查询用户通知列表（分页） -->
    <select id="selectByUserId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM notification
        WHERE to_user_id = #{userId}
          AND is_deleted = 0
        ORDER BY created_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 标记用户所有通知为已读 -->
    <update id="markAllAsReadByUserId">
        UPDATE notification
        SET read_status = 1,
            read_time = NOW(),
            updated_time = NOW()
        WHERE to_user_id = #{userId}
          AND read_status = 0
          AND is_deleted = 0
    </update>

    <!-- 标记单个通知为已读 -->
    <update id="markAsRead">
        UPDATE notification
        SET read_status = 1,
            read_time = NOW(),
            updated_time = NOW()
        WHERE notification_id = #{notificationId}
          AND to_user_id = #{userId}
          AND read_status = 0
          AND is_deleted = 0
    </update>

    <!-- 根据消息ID查询通知 -->
    <select id="selectByMessageId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM notification
        WHERE message_id = #{messageId}
          AND is_deleted = 0
        LIMIT 1
    </select>

    <!-- 删除用户指定的通知（逻辑删除） -->
    <update id="deleteByIdAndUserId">
        UPDATE notification
        SET is_deleted = 1,
            updated_time = NOW()
        WHERE notification_id = #{notificationId}
          AND to_user_id = #{userId}
          AND is_deleted = 0
    </update>

    <!-- 批量删除用户的通知（逻辑删除） -->
    <update id="batchDeleteByUserId">
        UPDATE notification
        SET is_deleted = 1,
            updated_time = NOW()
        WHERE to_user_id = #{userId}
          AND notification_id IN
        <foreach collection="notificationIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
          AND is_deleted = 0
    </update>

    <!-- 查询用户按类型分组的通知统计 -->
    <select id="countByMessageType" resultMap="StatisticResultMap">
        SELECT
            message_type,
            COUNT(*) as count
        FROM notification
        WHERE to_user_id = #{userId}
          AND is_deleted = 0
        GROUP BY message_type
        ORDER BY count DESC
    </select>

</mapper>
